<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üíé Le Tr√©sor des Mots de Jingyi</title>
    <style>
        :root { --p: #3498db; --s: #2ecc71; --e: #e74c3c; --w: #f1c40f; --d: #2c3e50; --rv: #9b59b6; }
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .stats-bar { display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 50px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-item { font-weight: bold; font-size: 1.1em; }
        .daily-goal-box { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .progress-container { width: 100%; background: #eee; height: 18px; border-radius: 10px; margin-top: 10px; overflow: hidden; display: flex; border: 1px solid #ddd; }
        .bar { height: 100%; transition: width 0.5s; }
        .bar-new { background: var(--p); border-right: 2px solid white; } .bar-rev { background: var(--rv); }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        .mot { font-size: 2.2em; color: var(--p); font-weight: bold; margin: 5px 0; }
        .definition { margin: 10px 0; font-size: 1.05em; line-height: 1.5; color: #444; }
        .exemple { background: #f9f9f9; padding: 12px; border-left: 5px solid var(--p); border-radius: 0 10px 10px 0; font-size: 1em; margin: 10px 0; font-style: italic; color: #666; }
        .daily-item { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .daily-item:last-child { border-bottom: none; }
        .game-zone { background: #fffbe6; border: 2px dashed var(--w); }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 20px; }
        .opt-btn { background: white; border: 2px solid #ddd; padding: 18px; border-radius: 12px; cursor: pointer; text-align: left; font-size: 1.05em; width: 100%; transition: all 0.2s; outline: none; -webkit-tap-highlight-color: transparent; }
        .opt-btn:hover:not(:disabled) { border-color: #ddd; background: white; }
        .opt-btn:focus { outline: none; }
        .correct { background: var(--s) !important; color: white !important; border-color: var(--s) !important; }
        .wrong { background: var(--e) !important; color: white !important; border-color: var(--e) !important; }
        button.action-btn { background: var(--s); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.95em; }
        .lvl-badge { font-size: 0.7em; background: #eee; padding: 2px 8px; border-radius: 5px; color: #666; margin-left: 5px; }
        .mode-btn { border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: bold; background: #eee; color: #666; position: relative; }
        .mode-btn.active { background: var(--p); color: white; }
        .mode-btn.done::after { content: "‚úÖ"; position: absolute; top: -5px; right: -5px; font-size: 0.8em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 15% auto; padding: 30px; border-radius: 20px; width: 85%; max-width: 550px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 32px; cursor: pointer; color: #bbb; }
        #sync-status { position: fixed; bottom: 10px; right: 10px; font-size: 0.75em; color: white; background: #999; padding: 6px 12px; border-radius: 8px; z-index: 2000; }
        .notebook-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 10px; }
        .mastery-indicator { display: flex; gap: 5px; margin-top: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; border: 1px solid #ccc; }
        .dot.full { background: var(--s); border-color: var(--s); }
        /* Notebook grouping styles */
        .nb-group { margin-bottom: 15px; border-radius: 12px; overflow: hidden; }
        .nb-group-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; cursor: pointer; font-weight: bold;
            transition: all 0.2s;
        }
        .nb-group-header:hover { opacity: 0.9; }
        .nb-group-count { 
            background: rgba(255,255,255,0.3); 
            padding: 2px 10px; border-radius: 20px; 
            font-size: 0.85em;
        }
        .nb-group-content { max-height: 300px; overflow-y: auto; }
        .nb-group-content.collapsed { display: none; }
        .nb-beginner { background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%); color: white; }
        .nb-consolidating { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: white; }
        .nb-advanced { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; }
        .nb-mastered { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .nb-search { 
            width: 100%; padding: 12px 15px; border: 2px solid #ddd; 
            border-radius: 25px; font-size: 1em; margin-bottom: 15px;
            box-sizing: border-box;
        }
        .nb-search:focus { outline: none; border-color: var(--p); }
        .nb-stats { 
            display: flex; justify-content: space-around; 
            padding: 10px; background: #f8f9fa; border-radius: 10px; 
            margin-bottom: 15px; font-size: 0.9em;
        }
        .nb-stat { text-align: center; }
        .nb-stat-value { font-weight: bold; color: var(--p); font-size: 1.2em; }
        .nb-empty { text-align: center; padding: 30px; color: #999; }
        .nb-word-due { background: #fff3cd !important; border-left: 4px solid #ffc107 !important; }
        .nb-word-error { background: #f8d7da !important; border-left: 4px solid #dc3545 !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="text-align: left; margin-bottom: 10px;">
                <a href="index.html" style="text-decoration: none; color: var(--p); font-weight: bold; font-size: 0.9em;">‚Üê Retour</a>
            </div>
            <h1>üíé Le Tr√©sor des Mots de Jingyi <span class="lvl-badge" style="background:var(--w); color:black; padding:6px 12px; font-size:0.5em;">CM1</span></h1>
            <p id="ui-date" style="font-weight: bold; color: var(--p); font-size: 1.1em; margin: 10px 0;"></p>
            <p style="color: #666; font-size: 0.9em;">Mission : Ma√Ætrise tous les mots !</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">‚≠ê <span id="ui-stars">0</span> Stars</div>
            <div class="stat-item">üèÜ <span id="ui-trophies">0</span> Troph√©es</div>
            <div class="stat-item" onclick="openNotebook()" style="cursor: pointer; color: var(--p); text-decoration: underline;">üìì <span id="ui-count">0</span> Mots</div>
        </div>

        <div class="daily-goal-box">
            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <strong>üéØ Progr√®s : <span style="color:var(--p)">Nouveaux</span> + <span style="color:var(--rv)">R√©vision</span></strong>
                <span id="ui-progress">0%</span>
            </div>
            <div class="progress-container"><div class="bar bar-new" id="bar-n"></div><div class="bar bar-rev" id="bar-r"></div></div>
            <div id="ui-completion-status" style="text-align:center; margin-top:5px; font-weight:bold; font-size:0.9em;"></div>
        </div>

        <div class="card">
            <h2>üåü Mots du Jour</h2>
            <div id="ui-words-list"></div>
        </div>

        <div class="card game-zone">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üéÆ D√©fi</h2>
                <div style="display:flex; gap:8px;">
                    <button id="mode-n" class="mode-btn active" onclick="setQuizMode('new')">Nouveaux</button>
                    <button id="mode-r" class="mode-btn" onclick="setQuizMode('rev')">R√©vision</button>
                </div>
            </div>
            <p style="font-size:0.85em;color:#666;margin:0 0 10px 0;font-style:italic;">üí° R√®gle : R√©ponds correctement 2 fois de suite pour ma√Ætriser un mot et gagner +100‚≠ê !</p>
            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <p>D√©finition de <strong id="q-word" style="color:var(--p)">?</strong></p>
                <div id="q-mastery" class="mastery-indicator"></div>
            </div>
            <div id="q-options" class="options-grid"></div>
            <p id="q-feedback" style="margin-top: 15px; font-weight: bold; text-align: center; font-size: 1.2em; min-height: 1.2em;"></p>
        </div>

        <div class="card" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div><h3 style="font-size:0.9em;color:var(--p)">‚úÖ Appris</h3><div id="list-new"></div></div>
            <div><h3 style="font-size:0.9em;color:var(--rv)">‚è≥ Mission</h3><div id="list-due"></div></div>
        </div>
    </div>

    <div id="sync-status">Initialisation...</div>

    <!-- NEW: HTTPS/Local IP Warning -->
    <div id="connection-warning" style="display:none; position:fixed; top:0; left:0; width:100%; background:#ef4444; color:white; padding:10px; text-align:center; font-size:0.8em; z-index:3000; font-weight:bold;">
        ‚ö†Ô∏è Mode "Consultation" (GitHub). Pour enregistrer tes progr√®s, utilise l'adresse IP locale de Papa sur l'iPad.
    </div>

    <div id="nbModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('nbModal')">&times;</span>
            <h2>üìì Mon Carnet <span id="nb-total" style="font-size:0.6em;color:#999;font-weight:normal;"></span></h2>
            
            <div class="nb-stats" id="nb-stats"></div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" class="nb-search" id="nb-search" placeholder="üîç Rechercher..." oninput="filterNotebook()" style="margin-bottom: 0; flex: 1;">
                <button onclick="saveData()" style="background: var(--p); color: white; border: none; padding: 0 15px; border-radius: 25px; font-size: 0.8em; cursor: pointer;">‚òÅÔ∏è Sync Mac</button>
            </div>
            <div id="nb-list"></div>
        </div>
    </div>
    <div id="detailModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('detailModal')">&times;</span><div id="detail-card"></div></div></div>
    <div id="rewardModal" class="modal"><div class="modal-content" style="text-align:center;"><h2>üéÅ BRAVO !</h2><p id="rew-val"></p><button class="action-btn" onclick="closeModal('rewardModal')">Merci Papa !</button></div></div>

    <script>
        const MAC_IP = "192.168.32.70";
        const PORT = "8888";
        // API address - detect if running on Mac mini or remote
        const isLocal = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" || window.location.hostname === MAC_IP || window.location.hostname === "TONGdeMac-mini.local");
        const API = isLocal ? `http://${window.location.hostname}:${PORT}` : `http://${MAC_IP}:${PORT}`;
        // For GitHub Pages and Local, we use relative paths for data
        const DATA_PATH = "./french_data.json";
        
        let gData = { stars: 100, notebook: [], daily_stats: { date: "", completed: false, words: [] }, last_milestone: 0 };
        let sessionMastery = {}; 
        let gTodayWords = [], gGameMode = 'new', gMistakes = {}, gCombo = 0, gIsLocked = false;
        const INTERVALS = [1, 2, 4, 7, 15, 30, 60];
        const MASTERY_GOAL = 2;

        const DB = [
            { word: "jour", def: "‰∏ÄÂ§©ÔºåÁôΩÂ§©", ex: "Un jour, je serai grand.", niveau: 1 },
            { word: "nuit", def: "Â§úÊôö", ex: "La nuit, les √©toiles brillent.", niveau: 1 },
            { word: "temps", def: "Êó∂Èó¥ÔºåÂ§©Ê∞î", ex: "Le temps passe vite.", niveau: 1 },
            { word: "ann√©e", def: "Âπ¥", ex: "Cette ann√©e, je suis en CM1.", niveau: 1 },
            { word: "mois", def: "Êúà", ex: "Il y a douze mois dans une ann√©e.", niveau: 1 },
            { word: "semaine", def: "ÊòüÊúü", ex: "Une semaine a sept jours.", niveau: 1 },
            { word: "heure", def: "Â∞èÊó∂", ex: "Il est quelle heure ?", niveau: 1 },
            { word: "minute", def: "ÂàÜÈíü", ex: "Attends une minute !", niveau: 1 },
            { word: "aujourd'hui", def: "‰ªäÂ§©", ex: "Aujourd'hui, il fait beau.", niveau: 1 },
            { word: "demain", def: "ÊòéÂ§©", ex: "Demain, c'est samedi.", niveau: 1 },
            { word: "hier", def: "Êò®Â§©", ex: "Hier, j'ai jou√© au foot.", niveau: 1 },
            { word: "matin", def: "Êó©‰∏ä", ex: "Le matin, je prends mon petit-d√©jeuner.", niveau: 1 },
            { word: "soir", def: "Êôö‰∏ä", ex: "Le soir, je lis avant de dormir.", niveau: 1 },
            { word: "apr√®s-midi", def: "‰∏ãÂçà", ex: "L'apr√®s-midi, nous avons sport.", niveau: 1 },
            { word: "√©cole", def: "Â≠¶Ê†°", ex: "Mon √©cole est grande et belle.", niveau: 1 },
            { word: "classe", def: "ÊïôÂÆ§ÔºåÁè≠Á∫ß", ex: "Ma classe est au premier √©tage.", niveau: 1 },
            { word: "cours", def: "ËØæÁ®ã", ex: "J'aime tous mes cours.", niveau: 1 },
            { word: "professeur", def: "ËÄÅÂ∏à", ex: "Mon professeur est tr√®s gentil.", niveau: 1 },
            { word: "√©l√®ve", def: "Â≠¶Áîü", ex: "Je suis un √©l√®ve s√©rieux.", niveau: 1 },
            { word: "cahier", def: "ÁªÉ‰π†Êú¨", ex: "J'√©cris dans mon cahier.", niveau: 1 },
            { word: "livre", def: "‰π¶", ex: "Ce livre est int√©ressant.", niveau: 1 },
            { word: "cartable", def: "‰π¶ÂåÖ", ex: "Mon cartable est lourd !", niveau: 1 },
            { word: "crayon", def: "ÈìÖÁ¨î", ex: "J'ai un crayon rouge.", niveau: 1 },
            { word: "stylo", def: "Èí¢Á¨î", ex: "J'√©cris avec un stylo bleu.", niveau: 1 },
            { word: "gomme", def: "Ê©°ÁöÆ", ex: "J'ai besoin d'une gomme.", niveau: 1 },
            { word: "r√®gle", def: "Â∞∫Â≠ê", ex: "Dessine une ligne avec ta r√®gle.", niveau: 1 },
            { word: "calcul", def: "ËÆ°ÁÆó", ex: "Le calcul est amusant.", niveau: 1 },
            { word: "dict√©e", def: "Âê¨ÂÜô", ex: "Nous avons une dict√©e demain.", niveau: 2 },
            { word: "devoir", def: "‰Ωú‰∏ö", ex: "J'ai fini mes devoirs.", niveau: 1 },
            { word: "examen", def: "ËÄÉËØï", ex: "L'examen n'est pas difficile.", niveau: 2 },
            { word: "note", def: "ÂàÜÊï∞", ex: "J'ai une bonne note.", niveau: 2 },
            { word: "r√©cr√©ation", def: "ËØæÈó¥‰ºëÊÅØ", ex: "√Ä la r√©cr√©ation, je joue avec mes amis.", niveau: 1 },
            { word: "cantine", def: "È£üÂ†Ç", ex: "Je mange √† la cantine.", niveau: 1 },
            { word: "biblioth√®que", def: "Âõæ‰π¶È¶Ü", ex: "La biblioth√®que a beaucoup de livres.", niveau: 2 },
            { word: "famille", def: "ÂÆ∂Â∫≠", ex: "Ma famille est nombreuse.", niveau: 1 },
            { word: "p√®re", def: "Áà∏Áà∏", ex: "Mon p√®re travaille dans un bureau.", niveau: 1 },
            { word: "m√®re", def: "Â¶àÂ¶à", ex: "Ma m√®re cuisine tr√®s bien.", niveau: 1 },
            { word: "parents", def: "Áà∂ÊØç", ex: "Mes parents m'aiment beaucoup.", niveau: 1 },
            { word: "fr√®re", def: "ÂÖÑÂºü", ex: "Mon fr√®re est plus grand que moi.", niveau: 1 },
            { word: "s≈ìur", def: "ÂßêÂ¶π", ex: "Ma s≈ìur joue du piano.", niveau: 1 },
            { word: "fils", def: "ÂÑøÂ≠ê", ex: "C'est le fils de mon oncle.", niveau: 2 },
            { word: "fille", def: "Â•≥ÂÑøÔºåÂ•≥Â≠©", ex: "Ma fille a√Æn√©e va au coll√®ge.", niveau: 2 },
            { word: "b√©b√©", def: "Â©¥ÂÑø", ex: "Le b√©b√© dort dans son lit.", niveau: 1 },
            { word: "maison", def: "ÊàøÂ≠ê", ex: "Ma maison est jaune.", niveau: 1 },
            { word: "appartement", def: "ÂÖ¨ÂØì", ex: "Nous vivons dans un appartement.", niveau: 2 },
            { word: "chambre", def: "ÂçßÂÆ§", ex: "Ma chambre est bien rang√©e.", niveau: 1 },
            { word: "salon", def: "ÂÆ¢ÂéÖ", ex: "Le salon est spacieux.", niveau: 2 },
            { word: "cuisine", def: "Âé®Êàø", ex: "La cuisine sent bon.", niveau: 1 },
            { word: "salle de bain", def: "Êµ¥ÂÆ§", ex: "La salle de bain est propre.", niveau: 2 },
            { word: "jardin", def: "Ëä±Âõ≠", ex: "Le jardin est plein de fleurs.", niveau: 1 },
            { word: "garage", def: "ËΩ¶Â∫ì", ex: "La voiture est dans le garage.", niveau: 2 },
            { word: "pain", def: "Èù¢ÂåÖ", ex: "Je mange du pain avec du beurre.", niveau: 1 },
            { word: "fromage", def: "Â•∂ÈÖ™", ex: "Le fromage fran√ßais est d√©licieux.", niveau: 1 },
            { word: "lait", def: "ÁâõÂ•∂", ex: "Je bois du lait le matin.", niveau: 1 },
            { word: "eau", def: "Ê∞¥", ex: "L'eau est essentielle pour la vie.", niveau: 1 },
            { word: "jus", def: "ÊûúÊ±Å", ex: "Je pr√©f√®re le jus d'orange.", niveau: 1 },
            { word: "fruit", def: "Ê∞¥Êûú", ex: "Les fruits sont bons pour la sant√©.", niveau: 1 },
            { word: "l√©gume", def: "Ëî¨Ëèú", ex: "Mange tes l√©gumes !", niveau: 1 },
            { word: "pomme", def: "ËãπÊûú", ex: "La pomme est rouge et sucr√©e.", niveau: 1 },
            { word: "banane", def: "È¶ôËïâ", ex: "La banane est jaune.", niveau: 1 },
            { word: "orange", def: "Ê©ôÂ≠ê", ex: "L'orange est acide mais bonne.", niveau: 1 },
            { word: "raisin", def: "Ëë°ËêÑ", ex: "Les raisins sont violets.", niveau: 2 },
            { word: "fraise", def: "ËçâËéì", ex: "Les fraises sont d√©licieuses.", niveau: 2 },
            { word: "tomate", def: "Ë•øÁ∫¢Êüø", ex: "La tomate est un fruit.", niveau: 1 },
            { word: "carotte", def: "ËÉ°ËêùÂçú", ex: "La carotte est orange.", niveau: 1 },
            { word: "pomme de terre", def: "ÂúüË±Ü", ex: "Les pommes de terre sont bonnes.", niveau: 2 },
            { word: "viande", def: "ËÇâ", ex: "La viande donne de l'√©nergie.", niveau: 2 },
            { word: "poulet", def: "È∏°ËÇâ", ex: "Le poulet est tendre.", niveau: 1 },
            { word: "poisson", def: "È±º", ex: "Le poisson est bon pour le cerveau.", niveau: 1 },
            { word: "≈ìuf", def: "È∏°Ëõã", ex: "Je mange un ≈ìuf pour le petit-d√©jeuner.", niveau: 1 },
            { word: "riz", def: "Á±≥È•≠", ex: "Le riz est la base de l'alimentation.", niveau: 2 },
            { word: "p√¢tes", def: "Èù¢Êù°", ex: "Les p√¢tes italiennes sont bonnes.", niveau: 2 },
            { word: "soupe", def: "Ê±§", ex: "La soupe est chaude.", niveau: 1 },
            { word: "salade", def: "Ê≤ôÊãâ", ex: "La salade est fra√Æche.", niveau: 1 },
            { word: "g√¢teau", def: "ËõãÁ≥ï", ex: "Le g√¢teau d'anniversaire est beau.", niveau: 1 },
            { word: "chocolat", def: "Â∑ßÂÖãÂäõ", ex: "J'aime le chocolat noir.", niveau: 1 },
            { word: "glace", def: "ÂÜ∞Ê∑áÊ∑ã", ex: "La glace est froide et sucr√©e.", niveau: 1 },
            { word: "sucre", def: "Á≥ñ", ex: "Ne mange pas trop de sucre.", niveau: 2 },
            { word: "sel", def: "Áõê", ex: "Le sel donne du go√ªt.", niveau: 2 },
            { word: "poivre", def: "ËÉ°Ê§í", ex: "Le poivre est √©pic√©.", niveau: 2 },
            { word: "chien", def: "Áãó", ex: "Le chien aboie.", niveau: 1 },
            { word: "chat", def: "Áå´", ex: "Le chat miaule.", niveau: 1 },
            { word: "oiseau", def: "È∏ü", ex: "L'oiseau chante dans l'arbre.", niveau: 1 },
            { word: "poisson", def: "È±º", ex: "Le poisson nage dans l'eau.", niveau: 1 },
            { word: "cheval", def: "È©¨", ex: "Le cheval court vite.", niveau: 2 },
            { word: "vache", def: "Áâõ", ex: "La vache donne du lait.", niveau: 1 },
            { word: "mouton", def: "Áæä", ex: "Le mouton a de la laine.", niveau: 2 },
            { word: "cochon", def: "Áå™", ex: "Le cochon aime la boue.", niveau: 2 },
            { word: "poule", def: "ÊØçÈ∏°", ex: "La poule pond des ≈ìufs.", niveau: 2 },
            { word: "canard", def: "È∏≠Â≠ê", ex: "Le canard nage dans l'√©tang.", niveau: 1 },
            { word: "lapin", def: "ÂÖîÂ≠ê", ex: "Le lapin a de longues oreilles.", niveau: 1 },
            { word: "souris", def: "ËÄÅÈº†", ex: "La souris est petite.", niveau: 2 },
            { word: "√©l√©phant", def: "Â§ßË±°", ex: "L'√©l√©phant est tr√®s grand.", niveau: 2 },
            { word: "lion", def: "ÁãÆÂ≠ê", ex: "Le lion est le roi des animaux.", niveau: 2 },
            { word: "tigre", def: "ËÄÅËôé", ex: "Le tigre a des rayures.", niveau: 2 },
            { word: "ours", def: "ÁÜä", ex: "L'ours aime le miel.", niveau: 2 },
            { word: "singe", def: "Áå¥Â≠ê", ex: "Le singe est intelligent.", niveau: 2 },
            { word: "serpent", def: "Ëõá", ex: "Le serpent rampe.", niveau: 3 },
            { word: "grenouille", def: "ÈùíËõô", ex: "La grenouille saute.", niveau: 2 },
            { word: "papillon", def: "Ëù¥Ëù∂", ex: "Le papillon vole de fleur en fleur.", niveau: 2 },
            { word: "abeille", def: "ËúúËúÇ", ex: "L'abeille fait du miel.", niveau: 2 },
            { word: "araign√©e", def: "ËúòËõõ", ex: "L'araign√©e tisse une toile.", niveau: 2 },
            { word: "soleil", def: "Â§™Èò≥", ex: "Le soleil brille.", niveau: 1 },
            { word: "lune", def: "Êúà‰∫Æ", ex: "La lune est ronde ce soir.", niveau: 1 },
            { word: "√©toile", def: "ÊòüÊòü", ex: "Les √©toiles brillent la nuit.", niveau: 1 },
            { word: "ciel", def: "Â§©Á©∫", ex: "Le ciel est bleu.", niveau: 1 },
            { word: "terre", def: "Âú∞ÁêÉÔºåÂúüÂú∞", ex: "La Terre tourne autour du Soleil.", niveau: 2 },
            { word: "mer", def: "Êµ∑", ex: "La mer est calme aujourd'hui.", niveau: 1 },
            { word: "rivi√®re", def: "Ê≤≥", ex: "La rivi√®re coule vers la mer.", niveau: 2 },
            { word: "lac", def: "Êπñ", ex: "Le lac est tranquille.", niveau: 2 },
            { word: "montagne", def: "Â±±", ex: "La montagne est haute.", niveau: 1 },
            { word: "for√™t", def: "Ê£ÆÊûó", ex: "La for√™t est verte.", niveau: 2 },
            { word: "arbre", def: "Ê†ë", ex: "L'arbre donne de l'ombre.", niveau: 1 },
            { word: "fleur", def: "Ëä±", ex: "La fleur sent bon.", niveau: 1 },
            { word: "feuille", def: "Âè∂Â≠ê", ex: "La feuille tombe en automne.", niveau: 1 },
            { word: "plante", def: "Ê§çÁâ©", ex: "La plante grandit.", niveau: 2 },
            { word: "herbe", def: "Ëçâ", ex: "L'herbe est verte.", niveau: 2 },
            { word: "vent", def: "È£é", ex: "Le vent souffle fort.", niveau: 1 },
            { word: "pluie", def: "Èõ®", ex: "La pluie tombe.", niveau: 1 },
            { word: "neige", def: "Èõ™", ex: "La neige est blanche.", niveau: 1 },
            { word: "nuage", def: "‰∫ë", ex: "Le nuage couvre le soleil.", niveau: 1 },
            { word: "arc-en-ciel", def: "ÂΩ©Ëôπ", ex: "L'arc-en-ciel a sept couleurs.", niveau: 2 },
            { word: "t√™te", def: "Â§¥", ex: "Je me lave la t√™te.", niveau: 1 },
            { word: "cheveu", def: "Â§¥Âèë", ex: "Mes cheveux sont noirs.", niveau: 2 },
            { word: "visage", def: "ËÑ∏", ex: "Mon visage est rond.", niveau: 2 },
            { word: "≈ìil", def: "ÁúºÁùõ", ex: "J'ai les yeux marron.", niveau: 1 },
            { word: "oreille", def: "ËÄ≥Êúµ", ex: "J'√©coute avec mes oreilles.", niveau: 1 },
            { word: "nez", def: "ÈºªÂ≠ê", ex: "Mon nez est petit.", niveau: 1 },
            { word: "bouche", def: "Âò¥", ex: "Je mange avec ma bouche.", niveau: 1 },
            { word: "dent", def: "ÁâôÈΩø", ex: "Je me brosse les dents.", niveau: 1 },
            { word: "langue", def: "ËàåÂ§¥", ex: "La langue aide √† go√ªter.", niveau: 2 },
            { word: "main", def: "Êâã", ex: "Je tape avec mes mains.", niveau: 1 },
            { word: "doigt", def: "ÊâãÊåá", ex: "J'ai dix doigts.", niveau: 1 },
            { word: "bras", def: "ÊâãËáÇ", ex: "Je l√®ve les bras.", niveau: 1 },
            { word: "jambe", def: "ËÖø", ex: "Je cours avec mes jambes.", niveau: 1 },
            { word: "pied", def: "ËÑö", ex: "Je marche avec mes pieds.", niveau: 1 },
            { word: "corps", def: "Ë∫´‰Ωì", ex: "Le corps humain est complexe.", niveau: 2 },
            { word: "rouge", def: "Á∫¢Ëâ≤", ex: "La pomme est rouge.", niveau: 1 },
            { word: "bleu", def: "ËìùËâ≤", ex: "Le ciel est bleu.", niveau: 1 },
            { word: "jaune", def: "ÈªÑËâ≤", ex: "Le soleil est jaune.", niveau: 1 },
            { word: "vert", def: "ÁªøËâ≤", ex: "L'herbe est verte.", niveau: 1 },
            { word: "noir", def: "ÈªëËâ≤", ex: "Le chat est noir.", niveau: 1 },
            { word: "blanc", def: "ÁôΩËâ≤", ex: "La neige est blanche.", niveau: 1 },
            { word: "gris", def: "ÁÅ∞Ëâ≤", ex: "Le nuage est gris.", niveau: 1 },
            { word: "marron", def: "Ê£ïËâ≤", ex: "Le chocolat est marron.", niveau: 1 },
            { word: "rose", def: "Á≤âËâ≤", ex: "La fleur est rose.", niveau: 1 },
            { word: "violet", def: "Á¥´Ëâ≤", ex: "Le raisin est violet.", niveau: 2 },
            { word: "orange", def: "Ê©ôËâ≤", ex: "L'orange est orange.", niveau: 1 },
            { word: "z√©ro", def: "Èõ∂", ex: "Z√©ro plus un √©gale un.", niveau: 1 },
            { word: "un", def: "‰∏Ä", ex: "J'ai un chat.", niveau: 1 },
            { word: "deux", def: "‰∫å", ex: "J'ai deux fr√®res.", niveau: 1 },
            { word: "trois", def: "‰∏â", ex: "Trois chats dorment.", niveau: 1 },
            { word: "quatre", def: "Âõõ", ex: "Quatre saisons dans l'ann√©e.", niveau: 1 },
            { word: "cinq", def: "‰∫î", ex: "J'ai cinq doigts.", niveau: 1 },
            { word: "six", def: "ÂÖ≠", ex: "Six jours d'√©cole.", niveau: 1 },
            { word: "sept", def: "‰∏É", ex: "Sept jours dans une semaine.", niveau: 1 },
            { word: "huit", def: "ÂÖ´", ex: "Huit heures du soir.", niveau: 1 },
            { word: "neuf", def: "‰πù", ex: "Neuf mois de grossesse.", niveau: 1 },
            { word: "dix", def: "ÂçÅ", ex: "Dix doigts au total.", niveau: 1 },
            { word: "vingt", def: "‰∫åÂçÅ", ex: "Vingt √©l√®ves dans ma classe.", niveau: 1 },
            { word: "trente", def: "‰∏âÂçÅ", ex: "Trente jours en avril.", niveau: 2 },
            { word: "cent", def: "‰∏ÄÁôæ", ex: "Cent euros.", niveau: 2 },
            { word: "mille", def: "‰∏ÄÂçÉ", ex: "Mille mercis !", niveau: 2 },
            { word: "grand", def: "Â§ßÁöÑ", ex: "L'√©l√©phant est grand.", niveau: 1 },
            { word: "petit", def: "Â∞èÁöÑ", ex: "La souris est petite.", niveau: 1 },
            { word: "long", def: "ÈïøÁöÑ", ex: "Le serpent est long.", niveau: 2 },
            { word: "court", def: "Áü≠ÁöÑ", ex: "Les cheveux courts.", niveau: 2 },
            { word: "gros", def: "ËÉñÁöÑ", ex: "L'ours est gros.", niveau: 1 },
            { word: "mince", def: "Áò¶ÁöÑ", ex: "Le mannequin est mince.", niveau: 2 },
            { word: "beau", def: "Áæé‰∏ΩÁöÑ", ex: "C'est une belle journ√©e.", niveau: 1 },
            { word: "joli", def: "ÊºÇ‰∫ÆÁöÑ", ex: "Une jolie fleur.", niveau: 1 },
            { word: "bon", def: "Â•ΩÁöÑ", ex: "C'est un bon √©l√®ve.", niveau: 1 },
            { word: "mauvais", def: "ÂùèÁöÑ", ex: "C'est une mauvaise id√©e.", niveau: 2 },
            { word: "nouveau", def: "Êñ∞ÁöÑ", ex: "J'ai un nouveau livre.", niveau: 1 },
            { word: "vieux", def: "ÊóßÁöÑ", ex: "C'est un vieux ch√¢teau.", niveau: 2 },
            { word: "jeune", def: "Âπ¥ËΩªÁöÑ", ex: "Elle est jeune et belle.", niveau: 1 },
            { word: "vieux", def: "ËÄÅÁöÑ", ex: "Mon grand-p√®re est vieux.", niveau: 1 },
            { word: "facile", def: "ÂÆπÊòìÁöÑ", ex: "Ce devoir est facile.", niveau: 1 },
            { word: "difficile", def: "Âõ∞ÈöæÁöÑ", ex: "Cette question est difficile.", niveau: 1 },
            { word: "rapide", def: "Âø´ÁöÑ", ex: "Le lapin est rapide.", niveau: 1 },
            { word: "lent", def: "ÊÖ¢ÁöÑ", ex: "La tortue est lente.", niveau: 2 },
            { word: "fort", def: "Âº∫Â£ÆÁöÑ", ex: "Le lion est fort.", niveau: 1 },
            { word: "faible", def: "ËôöÂº±ÁöÑ", ex: "Il est malade et faible.", niveau: 2 },
            { word: "chaud", def: "ÁÉ≠ÁöÑ", ex: "Le caf√© est chaud.", niveau: 1 },
            { word: "froid", def: "ÂÜ∑ÁöÑ", ex: "L'eau est froide.", niveau: 1 },
            { word: "propre", def: "Âπ≤ÂáÄÁöÑ", ex: "Ma chambre est propre.", niveau: 2 },
            { word: "sale", def: "ËÑèÁöÑ", ex: "Les v√™tements sont sales.", niveau: 2 },
            { word: "heureux", def: "ÂºÄÂøÉÁöÑ", ex: "Je suis heureux aujourd'hui.", niveau: 1 },
            { word: "triste", def: "‰º§ÂøÉÁöÑ", ex: "Elle est triste.", niveau: 1 },
            { word: "content", def: "Êª°ÊÑèÁöÑ", ex: "Je suis content de te voir.", niveau: 1 },
            { word: "fatigu√©", def: "Á¥ØÁöÑ", ex: "Je suis fatigu√© apr√®s le sport.", niveau: 2 },
            { word: "malade", def: "ÁîüÁóÖÁöÑ", ex: "Il ne va pas √† l'√©cole, il est malade.", niveau: 1 },
            { word: "sain", def: "ÂÅ•Â∫∑ÁöÑ", ex: "Mange sain pour √™tre en forme.", niveau: 3 },
            { word: "intelligent", def: "ËÅ™ÊòéÁöÑ", ex: "C'est un enfant intelligent.", niveau: 2 },
            { word: "gentil", def: "ÂñÑËâØÁöÑ", ex: "Elle est tr√®s gentille.", niveau: 1 },
            { word: "m√©chant", def: "ÂùèÁöÑ", ex: "Le m√©chant loup.", niveau: 2 },
            { word: "dr√¥le", def: "ÊúâË∂£ÁöÑ", ex: "Cette histoire est dr√¥le.", niveau: 2 },
            { word: "ennuyeux", def: "Êó†ËÅäÁöÑ", ex: "Ce film est ennuyeux.", niveau: 3 },
            { word: "int√©ressant", def: "ÊúâË∂£ÁöÑ", ex: "Ce livre est int√©ressant.", niveau: 2 },
        ];

        async function init() {
            document.getElementById('ui-date').innerText = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Check if running from GitHub (HTTPS) while API is HTTP
                if (window.location.protocol === 'https:' && API.startsWith('http://')) {
                    document.getElementById('connection-warning').style.display = 'block';
                }

                const response = await fetch(`${DATA_PATH}?t=${Date.now()}`);
                const localSaved = localStorage.getItem('french_learning_data');
                const localData = localSaved ? JSON.parse(localSaved) : null;

                if (response.ok) {
                    const serverData = await response.json();
                    
                    // CRITICAL: Conflict Resolution Logic
                    // If local data exists and has MORE stars or MORE notebook entries, it's ahead of server.
                    if (localData && (
                        (localData.stars > (serverData.stars || 0)) || 
                        (localData.notebook && serverData.notebook && localData.notebook.length > serverData.notebook.length)
                    )) {
                        console.log("üöÄ Local data is ahead. Syncing local to server...");
                        gData = localData;
                        await saveData(); // Push local state to server
                    } else {
                        gData = serverData;
                        localStorage.setItem('french_learning_data', JSON.stringify(gData));
                    }
                    
                    updateSyncStatus("‚òÅÔ∏è Synchronis√©", "#3498db");
                } else if (localData) {
                    gData = localData;
                    updateSyncStatus("‚ö†Ô∏è Offline (Local Mode)", "#e67e22");
                }

                if (!gData.notebook) gData.notebook = [];
                
                if (!gData.daily_stats || gData.daily_stats.date !== today) {
                    const seedVal = today.split('-').reduce((a, b) => a + b.charCodeAt(0), 0);
                    let pool = DB.filter(v => !gData.notebook.some(n => n.word === v.word));
                    if (pool.length < 5) pool = [...DB];
                    
                    let newDaily = []; let tPool = [...pool];
                    let s = seedVal;
                    for (let i=0; i<5; i++) { 
                        let idx = s % tPool.length;
                        newDaily.push(tPool.splice(idx, 1)[0].word); 
                        s = s * 31 + 7; 
                    }
                    
                    gData.daily_stats = { date: today, completed: false, words: newDaily };

                    // Logic for manual add remains: user clicks "Ajouter" button
                    localStorage.removeItem('french_session_mastery');
sessionStorage.removeItem('french_session_mastery');
                }
                
                gTodayWords = gData.daily_stats.words.map(wName => DB.find(d => d.word === wName));
                
                // Load session mastery from localStorage (persistent across refreshes)
                const savedSession = localStorage.getItem('french_session_mastery');
                if (savedSession) {
                    const parsedSession = JSON.parse(savedSession);
                    if (parsedSession.date === today) sessionMastery = parsedSession.data;
                    else {
                        sessionMastery = {};
                        localStorage.removeItem('french_session_mastery');
                    }
                } else {
                    // Fallback to sessionStorage for backward compatibility
                    const legacySession = sessionStorage.getItem('french_session_mastery');
                    if (legacySession) {
                        const parsedLegacy = JSON.parse(legacySession);
                        if (parsedLegacy.date === today) {
                            sessionMastery = parsedLegacy.data;
                            // Migrate to localStorage
                            localStorage.setItem('french_session_mastery', JSON.stringify(parsedLegacy));
                        } else sessionMastery = {};
                    } else sessionMastery = {};
                }
                
                // Warn user before refresh if quiz is in progress
                window.addEventListener('beforeunload', (e) => {
                    if (!gData.daily_stats.completed) {
                        const info = calculateProgress();
                        if (info.newPercent < 100) {
                            e.preventDefault();
                            e.returnValue = '‚ö†Ô∏è Quiz en cours ! Ta progression sera perdue si tu quittes maintenant.';
                        }
                    }
                });
                
                document.getElementById('sync-status').innerText = "‚úÖ Pr√™t";
                document.getElementById('sync-status').style.background = "#2ecc71";
            } catch (e) { document.getElementById('sync-status').innerText = "‚ö†Ô∏è Offline"; }
            
            refreshUI();
        }

        function calculateProgress() {
            const today = new Date().toISOString().split('T')[0];
            const newTotal = 5 * MASTERY_GOAL;
            let newCorrect = 0;
            gTodayWords.forEach(w => { 
                if (gData.notebook.some(n => n.word === w.word)) {
                    newCorrect += Math.min(MASTERY_GOAL, sessionMastery[w.word] || 0); 
                }
            });
            const newPercent = (newCorrect / newTotal) * 100;
            
            const reviewWords = DB.filter(v => { 
                const n = gData.notebook.find(e => e.word === v.word); 
                return n && n.next <= today && !gTodayWords.some(tw => tw.word === v.word); 
            });
            const revTotal = reviewWords.length * MASTERY_GOAL;
            let revCorrect = 0;
            reviewWords.forEach(w => { revCorrect += Math.min(MASTERY_GOAL, sessionMastery[w.word] || 0); });
            const revPercent = (reviewWords.length === 0) ? 100 : (revCorrect / revTotal) * 100;
            
            return { newCorrect, newTotal, newPercent, revCorrect, revTotal, revPercent, revCount: reviewWords.length };
        }

        function refreshUI() {
            document.getElementById('ui-stars').innerText = gData.stars || 0;
            document.getElementById('ui-trophies').innerText = Math.floor((gData.stars || 0) / 1000);
            document.getElementById('ui-count').innerText = gData.notebook.length;
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('ui-words-list').innerHTML = gTodayWords.map(w => `
                <div class="daily-item"><div class="mot">${w.word}</div><div class="definition">${w.def}</div><div class="exemple">"${w.ex}"</div>
                <div style="margin-top:10px"><button class="action-btn" onclick="speak('${w.word}')">üîä √âcouter</button>
                <button class="action-btn" style="background:${gData.notebook.some(n=>n.word===w.word)?'#ccc':'var(--p)'}" onclick="addWord('${w.word}')">${gData.notebook.some(n=>n.word===w.word)?'‚úÖ Ajout√©':'üìì Ajouter'}</button></div>
                </div>`).join('');

            const info = calculateProgress();
            document.getElementById('bar-n').style.width = info.newPercent + "%";
            document.getElementById('bar-r').style.width = info.revPercent + "%";
            
            const hasReview = info.revCount > 0;
            const totalPercent = hasReview ? Math.round((info.newPercent + info.revPercent) / 2) : Math.round(info.newPercent);
            document.getElementById('ui-progress').innerHTML = totalPercent + "%";
            
            const completionStatus = document.getElementById('ui-completion-status');
            if (gData.daily_stats.completed) { 
                completionStatus.innerText = "üåü MISSION ACCOMPLIE !"; completionStatus.style.color = "#2ecc71"; 
            } else if (totalPercent >= 100) { 
                completionStatus.innerText = "‚ú® PR√äT √Ä VALIDER !"; completionStatus.style.color = "#f1c40f"; 
            } else { completionStatus.innerText = ""; }

            document.getElementById('mode-n').classList.toggle('done', info.newPercent >= 100);
            document.getElementById('mode-r').classList.toggle('done', info.revPercent >= 100);

            document.getElementById('list-new').innerHTML = gData.notebook.filter(n => gTodayWords.some(tw => tw.word === n.word)).map(n => `<div onclick="showDetail('${n.word}')" style="cursor:pointer; margin-bottom:5px;">‚Ä¢ ${n.word}</div>`).join('') || "Rien encore";
            document.getElementById('list-due').innerHTML = gData.notebook.filter(n => n.next <= today && !gTodayWords.some(tw => tw.word === n.word)).map(n => `<div onclick="showDetail('${n.word}')" style="cursor:pointer; margin-bottom:5px;">‚Ä¢ ${n.word} <span class="lvl-badge">Lvl ${n.lvl}</span></div>`).join('') || (hasReview ? "Fini ! üéâ" : "Rien aujourd'hui");
            
            saveData(); saveSession(); updateQuiz();
        }

        function openNotebook() {
            renderNotebook();
            openModal('nbModal');
        }

        function renderNotebook(filterText = '') {
            const nbListEl = document.getElementById('nb-list');
            const today = new Date().toISOString().split('T')[0];
            
            if (!gData.notebook || gData.notebook.length === 0) {
                nbListEl.innerHTML = "<div class='nb-empty'>üì≠ Ton carnet est vide.<br>Commence par ajouter des mots du jour !</div>";
                document.getElementById('nb-total').innerText = '';
                document.getElementById('nb-stats').innerHTML = '';
                return;
            }

            // Filter words if search text provided
            let words = gData.notebook;
            if (filterText) {
                words = words.filter(n => n.word.toLowerCase().includes(filterText.toLowerCase()));
            }

            // Group by level
            const groups = {
                beginner: { title: 'üü† D√©butant', words: [], class: 'nb-beginner', expanded: true },
                consolidating: { title: 'üü° Consolidation', words: [], class: 'nb-consolidating', expanded: false },
                advanced: { title: 'üü¢ Avanc√©', words: [], class: 'nb-advanced', expanded: false },
                mastered: { title: 'üîµ Ma√Ætris√©', words: [], class: 'nb-mastered', expanded: false }
            };

            words.forEach(n => {
                const wordData = DB.find(d => d.word === n.word);
                if (!wordData) return;
                
                if (n.lvl <= 1) groups.beginner.words.push({...n, data: wordData});
                else if (n.lvl <= 3) groups.consolidating.words.push({...n, data: wordData});
                else if (n.lvl <= 5) groups.advanced.words.push({...n, data: wordData});
                else groups.mastered.words.push({...n, data: wordData});
            });

            // Update stats
            const total = gData.notebook.length;
            const dueToday = gData.notebook.filter(n => n.next <= today).length;
            const withErrors = gData.notebook.filter(n => n.err_days > 0).length;
            document.getElementById('nb-total').innerText = `(${total} mots)`;
            document.getElementById('nb-stats').innerHTML = `
                <div class="nb-stat"><div class="nb-stat-value">${total}</div><div>Total</div></div>
                <div class="nb-stat"><div class="nb-stat-value" style="color:#f39c12">${dueToday}</div><div>√Ä r√©viser</div></div>
                <div class="nb-stat"><div class="nb-stat-value" style="color:#e74c3c">${withErrors}</div><div>Difficult√©s</div></div>
            `;

            // Render groups
            let html = '';
            let hasContent = false;
            
            for (const [key, group] of Object.entries(groups)) {
                if (group.words.length === 0) continue;
                hasContent = true;
                
                const isExpanded = filterText ? true : group.expanded;
                const arrow = isExpanded ? '‚ñº' : '‚ñ∂';
                
                html += `
                    <div class="nb-group">
                        <div class="nb-group-header ${group.class}" onclick="toggleGroup('${key}')">
                            <span>${arrow} ${group.title}</span>
                            <span class="nb-group-count">${group.words.length}</span>
                        </div>
                        <div class="nb-group-content ${isExpanded ? '' : 'collapsed'}" id="nb-group-${key}">
                            ${group.words.map(n => {
                                const isDue = n.next <= today && !gTodayWords.some(tw => tw.word === n.word);
                                const hasError = n.err_days > 0;
                                const dueClass = hasError ? 'nb-word-error' : (isDue ? 'nb-word-due' : '');
                                const dueBadge = isDue ? ' <span style="color:#f39c12;font-size:0.8em;">‚è∞</span>' : '';
                                const errorBadge = hasError ? ` <span style="color:#e74c3c;font-size:0.8em;">‚ö†Ô∏è${n.err_days}</span>` : '';
                                
                                return `
                                <div class="notebook-item ${dueClass}" onclick="showDetail('${n.word}')">
                                    <div style="display:flex;flex-direction:column;flex:1;">
                                        <span style="font-size:1.1em;"><strong>${n.word}</strong>${dueBadge}${errorBadge}</span>
                                        <span style="font-size:0.85em;color:#666;margin-top:3px;">${n.data.def.substring(0, 50)}...</span>
                                        <span style="font-size:0.75em;color:#999;margin-top:2px;">Prochaine r√©vision: ${formatDate(n.next)}</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="lvl-badge">Lvl ${n.lvl}</span>
                                        <button onclick="event.stopPropagation(); speak('${n.word}')" style="background:var(--s);border:none;width:35px;height:35px;border-radius:50%;color:white;font-size:1.2em;cursor:pointer;display:flex;align-items:center;justify-content:center;">üîä</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (!hasContent && filterText) {
                html = "<div class='nb-empty'>üîç Aucun mot ne correspond √† ta recherche.</div>";
            }

            nbListEl.innerHTML = html;
        }

        function toggleGroup(groupKey) {
            const content = document.getElementById(`nb-group-${groupKey}`);
            const header = content.previousElementSibling;
            const isCollapsed = content.classList.contains('collapsed');
            
            content.classList.toggle('collapsed');
            header.innerHTML = header.innerHTML.replace(isCollapsed ? '‚ñ∂' : '‚ñº', isCollapsed ? '‚ñº' : '‚ñ∂');
        }

        function filterNotebook() {
            const searchText = document.getElementById('nb-search').value.trim();
            renderNotebook(searchText);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0,0,0,0);
            date.setHours(0,0,0,0);
            
            const diff = Math.round((date - today) / (1000 * 60 * 60 * 24));
            
            if (diff === 0) return "Aujourd'hui";
            if (diff === 1) return "Demain";
            if (diff < 0) return `En retard (${Math.abs(diff)}j)`;
            if (diff < 7) return `Dans ${diff} jours`;
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        async function saveData() { 
            localStorage.setItem('french_learning_data', JSON.stringify(gData));
            updateSyncStatus("‚è≥ Sauvegarde...", "#f1c40f");
            try { 
                const res = await fetch(`${API}/save_data`, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(gData) 
                }); 
                if (res.ok) {
                    updateSyncStatus("‚úÖ Enregistr√©", "#2ecc71");
                } else {
                    throw new Error("Server error");
                }
            } catch(e) {
                updateSyncStatus("‚ùå Error - Local Only", "#e74c3c");
                console.error("Save failed:", e);
            }
        }

        function updateSyncStatus(msg, bg) {
            const el = document.getElementById('sync-status');
            if (el) {
                el.innerText = msg;
                el.style.background = bg;
            }
        }
        function saveSession() { localStorage.setItem('french_session_mastery', JSON.stringify({ date: new Date().toISOString().split('T')[0], data: sessionMastery })); }
        function addWord(w) { 
            if (!gData.notebook.some(n => n.word === w)) { 
                gData.notebook.push({ word: w, lvl: 0, next: new Date().toISOString().split('T')[0], err_days: 0 }); 
                speak("Ajout√©"); refreshUI(); 
            } else { speak("D√©j√† l√†"); }
        }

        function setQuizMode(m) { gGameMode = m; document.getElementById('mode-n').classList.toggle('active', m==='new'); document.getElementById('mode-r').classList.toggle('active', m==='rev'); updateQuiz(); }
        
        function updateQuiz() {
            const today = new Date().toISOString().split('T')[0];
            let pool = [];
            if (gGameMode === 'new') {
                pool = gTodayWords.filter(w => gData.notebook.some(n => n.word === w.word) && (sessionMastery[w.word] || 0) < MASTERY_GOAL);
            } else {
                pool = DB.filter(v => { 
                    const n = gData.notebook.find(e => e.word === v.word); 
                    return n && n.next <= today && !gTodayWords.some(tw => tw.word === v.word) && (sessionMastery[v.word] || 0) < MASTERY_GOAL; 
                });
            }
            
            document.getElementById('q-feedback').innerText = "";
            gIsLocked = false;

            if (pool.length < 1) { 
                const isNew = gGameMode === 'new';
                let msg = "";
                if (isNew) {
                    msg = gData.notebook.filter(n => gTodayWords.some(tw => tw.word === n.word)).length < 5 
                          ? "Ajoute les 5 mots du jour pour commencer !" 
                          : "üåü Nouveaux mots ma√Ætris√©s !";
                } else { msg = "üéâ R√©visions termin√©es !"; }
                document.getElementById('q-options').innerHTML = `<p style='padding:20px; color:var(--p); font-weight:bold; text-align:center;'>${msg}</p>`; 
                document.getElementById('q-word').innerText = "Salut !"; 
                document.getElementById('q-mastery').innerHTML = "";
                return; 
            }
            
            const target = pool[Math.floor(Math.random() * pool.length)]; 
            document.getElementById('q-word').innerText = target.word;
            const mCount = sessionMastery[target.word] || 0;
            document.getElementById('q-mastery').innerHTML = Array(MASTERY_GOAL).fill(0).map((_, i) => `<div class="dot ${i < mCount ? 'full' : ''}"></div>`).join('');
            
            let opts = [target.def]; let all = DB.map(v => v.def);
            while(opts.length < 3) { let r = all[Math.floor(Math.random()*all.length)]; if(!opts.includes(r)) opts.push(r); }
            opts.sort(() => Math.random() - 0.5);
            document.getElementById('q-options').innerHTML = opts.map(o => `<button class="opt-btn" onclick="checkQuiz(this, '${o.replace(/'/g, "\\'")}', '${target.word}')">${o}</button>`).join('');
            
            // Remove focus/outline
            if (document.activeElement) document.activeElement.blur();
        }

        function checkQuiz(btn, sel, w) {
            if (gIsLocked) return;
            gIsLocked = true;
            const target = DB.find(v => v.word === w), n = gData.notebook.find(e => e.word === w);
            const feedbackEl = document.getElementById('q-feedback');
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true);

            if (sel === target.def) {
                btn.classList.add('correct');
                feedbackEl.innerHTML = "‚úÖ Tr√®s bien !"; feedbackEl.style.color = "var(--s)";
                sessionMastery[w] = (sessionMastery[w] || 0) + 1;
                if (sessionMastery[w] >= MASTERY_GOAL && n) {
                    n.lvl = Math.min(6, n.lvl + 1); n.err_days = 0; 
                    let d = new Date(); d.setDate(d.getDate() + INTERVALS[n.lvl]); n.next = d.toISOString().split('T')[0]; 
                }
                gCombo++; delete gMistakes[w]; speak("Tr√®s bien"); 
                setTimeout(() => { 
                    checkDailyCompletion(); 
                    refreshProgressOnly(); 
                    updateQuiz(); 
                }, 1000);
            } else {
                btn.classList.add('wrong');
                feedbackEl.innerHTML = "‚ùå Dommage !"; feedbackEl.style.color = "var(--e)";
                sessionMastery[w] = 0;
                allBtns.forEach(b => { if(b.innerText === target.def) b.classList.add('correct'); });
                if (!gMistakes[w]) {
                    gMistakes[w] = 1;
                    setTimeout(() => { 
                        refreshProgressOnly(); 
                        updateQuiz(); 
                    }, 1800);
                } else {
                    gCombo = 0; 
                    if (n) { 
                        n.lvl = 0; let d = new Date(); d.setDate(d.getDate() + 1); n.next = d.toISOString().split('T')[0]; 
                        n.err_days = (n.err_days || 0) + 1; if (n.err_days >= 2) gData.notebook = gData.notebook.filter(e => e.word !== w);
                    }
                    delete gMistakes[w];
                    setTimeout(() => { 
                        refreshProgressOnly(); 
                        updateQuiz(); 
                    }, 1800);
                }
                speak("Dommage");
            }
        }

        function refreshProgressOnly() {
            const info = calculateProgress();
            document.getElementById('bar-n').style.width = info.newPercent + "%";
            document.getElementById('bar-r').style.width = info.revPercent + "%";
            const hasReview = info.revCount > 0;
            const totalPercent = hasReview ? Math.round((info.newPercent + info.revPercent) / 2) : Math.round(info.newPercent);
            document.getElementById('ui-progress').innerHTML = totalPercent + "%";
            document.getElementById('ui-stars').innerText = gData.stars || 0;
            saveData(); saveSession();
        }
        
        function checkDailyCompletion() {
            const info = calculateProgress();
            const hasReview = info.revCount > 0;
            const total = hasReview ? (info.newPercent + info.revPercent) / 200 : info.newPercent / 100;
            if (total >= 1.0 && !gData.daily_stats.completed) {
                gData.stars = (gData.stars || 0) + 100; gData.daily_stats.completed = true;
                setTimeout(() => { document.getElementById('rew-val').innerText = "üéâ Magnifique !\nTu as ma√Ætris√© tous les mots !\n+100 √©toiles !"; openModal('rewardModal'); speak("F√©licitations"); }, 500);
            }
        }

        function showDetail(w) { const d = DB.find(v => v.word === w); document.getElementById('detail-card').innerHTML = `<h2>${d.word}</h2><p><strong>üìù D√©finition:</strong><br>${d.def}</p><p><strong>üí¨ Exemple:</strong><br><i>"${d.ex}"</i></p><button class="action-btn" style="width:100%;margin-top:20px" onclick="speak('${d.word}')">üîä √âcouter</button>`; openModal('detailModal'); speak(w); }
        function openModal(id) { document.getElementById(id).style.display = "block"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function speak(t) { const m = new SpeechSynthesisUtterance(t); m.lang = 'fr-FR'; window.speechSynthesis.speak(m); }
        window.onclick = e => { if (e.target.className === 'modal') e.target.style.display = "none"; };
        
        // Auto-retry background sync if in error state
        setInterval(async () => {
            const el = document.getElementById('sync-status');
            if (el && el.innerText.includes("Error")) {
                console.log("Retrying background sync...");
                try {
                    const res = await fetch(`${API}/save_data`, { 
                        method:'POST', 
                        headers:{'Content-Type':'application/json'}, 
                        body:JSON.stringify(gData) 
                    });
                    if (res.ok) updateSyncStatus("‚úÖ Enregistr√©", "#2ecc71");
                } catch(e) {}
            }
        }, 30000);

        window.onload = init;
    </script>
</body>
</html>
