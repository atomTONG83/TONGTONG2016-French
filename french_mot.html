<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üíé Le Tr√©sor des Mots de Jingyi</title>
    <style>
        :root { --p: #3498db; --s: #2ecc71; --e: #e74c3c; --w: #f1c40f; --d: #2c3e50; --rv: #9b59b6; }
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .stats-bar { display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 50px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-item { font-weight: bold; font-size: 1.1em; }
        .daily-goal-box { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .progress-container { width: 100%; background: #eee; height: 18px; border-radius: 10px; margin-top: 10px; overflow: hidden; display: flex; border: 1px solid #ddd; }
        .bar { height: 100%; transition: width 0.5s; }
        .bar-new { background: var(--p); border-right: 2px solid white; } .bar-rev { background: var(--rv); }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        .mot { font-size: 2.2em; color: var(--p); font-weight: bold; margin: 5px 0; }
        .definition { margin: 10px 0; font-size: 1.05em; line-height: 1.5; color: #444; }
        .exemple { background: #f9f9f9; padding: 12px; border-left: 5px solid var(--p); border-radius: 0 10px 10px 0; font-size: 1em; margin: 10px 0; font-style: italic; color: #666; }
        .daily-item { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .daily-item:last-child { border-bottom: none; }
        .game-zone { background: #fffbe6; border: 2px dashed var(--w); }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 20px; }
        .opt-btn { background: white; border: 2px solid #ddd; padding: 18px; border-radius: 12px; cursor: pointer; text-align: left; font-size: 1.05em; width: 100%; transition: all 0.2s; outline: none; -webkit-tap-highlight-color: transparent; }
        .opt-btn:hover:not(:disabled) { border-color: #ddd; background: white; }
        .opt-btn:focus { outline: none; }
        .correct { background: var(--s) !important; color: white !important; border-color: var(--s) !important; }
        .wrong { background: var(--e) !important; color: white !important; border-color: var(--e) !important; }
        button.action-btn { background: var(--s); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.95em; }
        .lvl-badge { font-size: 0.7em; background: #eee; padding: 2px 8px; border-radius: 5px; color: #666; margin-left: 5px; }
        .mode-btn { border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: bold; background: #eee; color: #666; position: relative; }
        .mode-btn.active { background: var(--p); color: white; }
        .mode-btn.done::after { content: "‚úÖ"; position: absolute; top: -5px; right: -5px; font-size: 0.8em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 15% auto; padding: 30px; border-radius: 20px; width: 85%; max-width: 550px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 32px; cursor: pointer; color: #bbb; }
        #sync-status { position: fixed; bottom: 10px; right: 10px; font-size: 0.75em; color: white; background: #999; padding: 6px 12px; border-radius: 8px; z-index: 2000; }
        .notebook-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 10px; }
        .mastery-indicator { display: flex; gap: 5px; margin-top: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; border: 1px solid #ccc; }
        .dot.full { background: var(--s); border-color: var(--s); }
        .nb-group { margin-bottom: 15px; border-radius: 12px; overflow: hidden; }
        .nb-group-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .nb-group-header:hover { opacity: 0.9; }
        .nb-group-count { background: rgba(255,255,255,0.3); padding: 2px 10px; border-radius: 20px; font-size: 0.85em; }
        .nb-group-content { max-height: 300px; overflow-y: auto; }
        .nb-group-content.collapsed { display: none; }
        .nb-beginner { background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%); color: white; }
        .nb-consolidating { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: white; }
        .nb-advanced { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; }
        .nb-mastered { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .nb-search { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 25px; font-size: 1em; margin-bottom: 15px; box-sizing: border-box; }
        .nb-search:focus { outline: none; border-color: var(--p); }
        .nb-stats { display: flex; justify-content: space-around; padding: 10px; background: #f8f9fa; border-radius: 10px; margin-bottom: 15px; font-size: 0.9em; }
        .nb-stat { text-align: center; }
        .nb-stat-value { font-weight: bold; color: var(--p); font-size: 1.2em; }
        .nb-empty { text-align: center; padding: 30px; color: #999; }
        .nb-word-due { background: #fff3cd !important; border-left: 4px solid #ffc107 !important; }
        .nb-word-error { background: #f8d7da !important; border-left: 4px solid #dc3545 !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="text-align: left; margin-bottom: 10px;">
                <a href="index.html" style="text-decoration: none; color: var(--p); font-weight: bold; font-size: 0.9em;">‚Üê Retour</a>
            </div>
            <h1>üíé Le Tr√©sor des Mots de Jingyi <span class="lvl-badge" style="background:var(--w); color:black; padding:6px 12px; font-size:0.5em;">CM1</span></h1>
            <p id="ui-date" style="font-weight: bold; color: var(--p); font-size: 1.1em; margin: 10px 0;"></p>
            <p style="color: #666; font-size: 0.9em;">Mission : Ma√Ætrise tous les mots !</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">‚≠ê <span id="ui-stars">0</span> Stars</div>
            <div class="stat-item">üèÜ <span id="ui-trophies">0</span> Troph√©es</div>
            <div class="stat-item" onclick="openNotebook()" style="cursor: pointer; color: var(--p); text-decoration: underline;">üìì <span id="ui-count">0</span> Mots</div>
        </div>

        <div class="daily-goal-box">
            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <strong>üéØ Progr√®s : <span style="color:var(--p)">Nouveaux</span> + <span style="color:var(--rv)">R√©vision</span></strong>
                <span id="ui-progress">0%</span>
            </div>
            <div class="progress-container"><div class="bar bar-new" id="bar-n"></div><div class="bar bar-rev" id="bar-r"></div></div>
            <div id="ui-completion-status" style="text-align:center; margin-top:5px; font-weight:bold; font-size:0.9em;"></div>
        </div>

        <div class="card">
            <h2>üåü Mots du Jour</h2>
            <div id="ui-words-list"></div>
        </div>

        <div class="card game-zone">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üéÆ D√©fi</h2>
                <div style="display:flex; gap:8px;">
                    <button id="mode-n" class="mode-btn active" onclick="setQuizMode('new')">Nouveaux</button>
                    <button id="mode-r" class="mode-btn" onclick="setQuizMode('rev')">R√©vision</button>
                </div>
            </div>
            <p style="font-size:0.85em;color:#666;margin:0 0 10px 0;font-style:italic;">üí° R√®gle : R√©ponds correctement 2 fois de suite pour ma√Ætriser un mot et gagner +100‚≠ê !</p>
            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <p>D√©finition de <strong id="q-word" style="color:var(--p)">?</strong></p>
                <div id="q-mastery" class="mastery-indicator"></div>
            </div>
            <div id="q-options" class="options-grid"></div>
            <p id="q-feedback" style="margin-top: 15px; font-weight: bold; text-align: center; font-size: 1.2em; min-height: 1.2em;"></p>
        </div>

        <div class="card" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div><h3 style="font-size:0.9em;color:var(--p)">‚úÖ Appris</h3><div id="list-new"></div></div>
            <div><h3 style="font-size:0.9em;color:var(--rv)">‚è≥ Mission</h3><div id="list-due"></div></div>
        </div>
    </div>

    <div id="sync-status">Initialisation...</div>

    <div id="connection-warning" style="display:none; position:fixed; top:0; left:0; width:100%; background:#ef4444; color:white; padding:10px; text-align:center; font-size:0.8em; z-index:3000; font-weight:bold;">
        ‚ö†Ô∏è Mode "Consultation" (GitHub). Pour enregistrer tes progr√®s, utilise l'adresse IP locale de Papa sur l'iPad.
    </div>

    <div id="nbModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('nbModal')">&times;</span>
            <h2>üìì Mon Carnet <span id="nb-total" style="font-size:0.6em;color:#999;font-weight:normal;"></span></h2>
            <div class="nb-stats" id="nb-stats"></div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" class="nb-search" id="nb-search" placeholder="üîç Rechercher..." oninput="filterNotebook()" style="margin-bottom: 0; flex: 1;">
                <button onclick="saveData()" style="background: var(--p); color: white; border: none; padding: 0 15px; border-radius: 25px; font-size: 0.8em; cursor: pointer;">‚òÅÔ∏è Sync Mac</button>
            </div>
            <div id="nb-list"></div>
        </div>
    </div>
    <div id="detailModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('detailModal')">&times;</span><div id="detail-card"></div></div></div>
    <div id="rewardModal" class="modal"><div class="modal-content" style="text-align:center;"><h2>üéÅ BRAVO !</h2><p id="rew-val"></p><button class="action-btn" onclick="closeModal('rewardModal')">Merci Papa !</button></div></div>

    <script>
        // ===== IMMEDIATE STATUS UPDATE - Must run first =====
        (function() {
            try {
                var el = document.getElementById('sync-status');
                if (el) {
                    el.innerText = "JS Loading...";
                    el.style.background = "#9b59b6";
                }
            } catch(e) {}
        })();
        
        // ===== CONSTANTS =====
        const MAC_IP = "192.168.32.70";
        const PORT = "8888";
        const DATA_PATH = "./french_data.json";
        const INTERVALS = [1, 2, 4, 7, 15, 30, 60];
        const MASTERY_GOAL = 2;
        
        // ===== STATE =====
        let gData = { stars: 100, notebook: [], daily_stats: { date: "", completed: false, words: [] }, last_milestone: 0 };
        let sessionMastery = {}; 
        let gTodayWords = [];
        let gGameMode = 'new';
        let gMistakes = {};
        let gCombo = 0;
        let gIsLocked = false;
        let API = "";
        
        // ===== DATABASE =====
        const DB = [
            { word: "Soleil", def: "Â§™Èò≥", ex: "Le soleil brille.", niveau: 1 },
            { word: "Lune", def: "Êúà‰∫Æ", ex: "La lune est ronde.", niveau: 1 },
            { word: "Chat", def: "Áå´", ex: "Le chat miaule.", niveau: 1 },
            { word: "Chien", def: "Áãó", ex: "Le chien aboie.", niveau: 1 },
            { word: "Maison", def: "ÊàøÂ≠ê", ex: "Ma maison est jaune.", niveau: 1 },
            { word: "√âcole", def: "Â≠¶Ê†°", ex: "Je vais √† l'√©cole.", niveau: 1 },
            { word: "Famille", def: "ÂÆ∂Â∫≠", ex: "Ma famille est grande.", niveau: 1 },
            { word: "Ami", def: "ÊúãÂèã", ex: "Mon ami s'appelle Pierre.", niveau: 1 },
            { word: "Fleur", def: "Ëä±", ex: "La fleur est belle.", niveau: 1 },
            { word: "Arbre", def: "Ê†ë", ex: "L'arbre est grand.", niveau: 1 },
            { word: "Courage", def: "ÂãáÊ∞î", ex: "Il a du courage.", niveau: 2 },
            { word: "Patience", def: "ËÄêÂøÉ", ex: "La patience est une vertu.", niveau: 2 },
            { word: "Curiosit√©", def: "Â•ΩÂ•áÂøÉ", ex: "La curiosit√© est naturelle.", niveau: 2 },
            { word: "Imagination", def: "ÊÉ≥Ë±°Âäõ", ex: "L'imagination est cr√©ative.", niveau: 2 },
            { word: "Aventure", def: "ÂÜíÈô©", ex: "C'est une grande aventure.", niveau: 2 },
            { word: "Sinc√©rit√©", def: "ÁúüËØö", ex: "La sinc√©rit√© est importante.", niveau: 3 },
            { word: "Perspective", def: "ËßÜËßí", ex: "Chacun a sa perspective.", niveau: 3 },
            { word: "G√©n√©tique", def: "ÈÅó‰º†Â≠¶", ex: "La g√©n√©tique √©tudie l'h√©r√©dit√©.", niveau: 3 },
            { word: "Pr√©histoire", def: "Âè≤ÂâçÂè≤", ex: "La pr√©histoire est fascinante.", niveau: 3 },
            { word: "√âquilibre", def: "Âπ≥Ë°°", ex: "L'√©quilibre est essentiel.", niveau: 3 },
            { word: "Climax", def: "È´òÊΩÆ", ex: "Le film atteint son climax.", niveau: 3 },
            { word: "Friction", def: "Êë©Êì¶", ex: "La friction produit de la chaleur.", niveau: 3 },
            { word: "Conservation", def: "‰øùÊä§", ex: "La conservation de la nature.", niveau: 3 },
            { word: "Globalisation", def: "ÂÖ®ÁêÉÂåñ", ex: "La globalisation √©conomique.", niveau: 3 },
            { word: "Biotechnologie", def: "ÁîüÁâ©ÊäÄÊúØ", ex: "La biotechnologie moderne.", niveau: 3 },
            { word: "Empathie", def: "ÂÖ±ÊÉÖ", ex: "L'empathie aide √† comprendre.", niveau: 3 },
            { word: "Condensation", def: "ÂáùÁªì", ex: "La condensation sur la vitre.", niveau: 3 }
        ];
        
        // ===== INITIALIZATION =====
        async function init() {
            console.log("init() started");
            
            try {
                updateSyncStatus("Chargement...", "#f1c40f");
                
                var dateEl = document.getElementById('ui-date');
                if (dateEl) {
                    dateEl.innerText = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                const isLocal = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" || window.location.hostname === MAC_IP);
                API = isLocal ? "http://" + window.location.hostname + ":" + PORT : "http://" + MAC_IP + ":" + PORT;
                
                if (window.location.protocol === 'https:' && API.startsWith('http:')) {
                    var warnEl = document.getElementById('connection-warning');
                    if (warnEl) warnEl.style.display = 'block';
                }
                
                let serverData = null;
                try {
                    const response = await fetch(DATA_PATH + "?t=" + Date.now());
                    if (response.ok) {
                        serverData = await response.json();
                    }
                } catch (fetchErr) {
                    console.warn("Fetch failed:", fetchErr);
                }
                
                let localData = null;
                try {
                    const localSaved = localStorage.getItem('french_learning_data');
                    if (localSaved) localData = JSON.parse(localSaved);
                } catch (e) {
                    console.warn("LocalStorage read failed:", e);
                }
                
                if (serverData) {
                    gData = serverData;
                    try { localStorage.setItem('french_learning_data', JSON.stringify(gData)); } catch(e) {}
                    updateSyncStatus("Synchronis√©", "#3498db");
                } else if (localData) {
                    gData = localData;
                    updateSyncStatus("Mode hors ligne", "#e67e22");
                } else {
                    updateSyncStatus("Nouveau profil", "#9b59b6");
                }
                
                if (!gData.notebook) gData.notebook = [];
                if (!gData.stars) gData.stars = 100;
                if (!gData.daily_stats) gData.daily_stats = { date: "", completed: false, words: [] };
                
                if (gData.daily_stats.date !== today) {
                    generateDailyWords(today);
                }
                
                loadSessionMastery(today);
                
                gTodayWords = gData.daily_stats.words.map(function(w) {
                    return DB.find(function(d) { return d.word === w; });
                }).filter(function(x) { return x; });
                
                updateSyncStatus("Pr√™t", "#2ecc71");
                
            } catch (e) {
                console.error("Init error:", e);
                updateSyncStatus("Erreur: " + e.message, "#e74c3c");
            }
            
            refreshUI();
        }
        
        function generateDailyWords(today) {
            const seedVal = today.split('-').reduce(function(a, b) { return a + b.charCodeAt(0); }, 0);
            let pool = DB.filter(function(v) { 
                return !gData.notebook.some(function(n) { return n.word === v.word; }); 
            });
            if (pool.length < 5) pool = DB.slice();
            
            let newDaily = [];
            let tPool = pool.slice();
            let s = seedVal;
            for (let i = 0; i < 5 && tPool.length > 0; i++) { 
                let idx = s % tPool.length;
                newDaily.push(tPool.splice(idx, 1)[0].word); 
                s = s * 31 + 7; 
            }
            
            gData.daily_stats = { date: today, completed: false, words: newDaily };
            sessionMastery = {};
            try { localStorage.removeItem('french_session_mastery'); } catch(e) {}
        }
        
        function loadSessionMastery(today) {
            try {
                const saved = localStorage.getItem('french_session_mastery');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.date === today) {
                        sessionMastery = parsed.data || {};
                    } else {
                        sessionMastery = {};
                    }
                } else {
                    sessionMastery = {};
                }
            } catch (e) {
                sessionMastery = {};
            }
        }
        
        function updateSyncStatus(msg, bg) {
            try {
                var el = document.getElementById('sync-status');
                if (el) {
                    el.innerText = msg;
                    el.style.background = bg;
                }
            } catch(e) {}
        }
        
        function refreshUI() {
            var starsEl = document.getElementById('ui-stars');
            var trophiesEl = document.getElementById('ui-trophies');
            var countEl = document.getElementById('ui-count');
            
            if (starsEl) starsEl.innerText = gData.stars || 0;
            if (trophiesEl) trophiesEl.innerText = Math.floor((gData.stars || 0) / 1000);
            if (countEl) countEl.innerText = gData.notebook.length;
            
            var wordsListEl = document.getElementById('ui-words-list');
            if (wordsListEl) {
                wordsListEl.innerHTML = gTodayWords.map(function(w) {
                    var isAdded = gData.notebook.some(function(n) { return n.word === w.word; });
                    return '<div class="daily-item"><div class="mot">' + w.word + '</div><div class="definition">' + w.def + '</div><div class="exemple">"' + w.ex + '"</div><div style="margin-top:10px"><button class="action-btn" onclick="speak(\'' + w.word + '\')">Ecouter</button> <button class="action-btn" style="background:' + (isAdded ? '#ccc' : 'var(--p)') + '" onclick="addWord(\'' + w.word + '\')">' + (isAdded ? 'Ajoute' : 'Ajouter') + '</button></div></div>';
                }).join('');
            }
            
            updateQuiz();
        }
        
        function saveSession() {
            try {
                localStorage.setItem('french_session_mastery', JSON.stringify({ 
                    date: new Date().toISOString().split('T')[0], 
                    data: sessionMastery 
                }));
            } catch(e) {}
        }
        
        async function saveData() {
            try {
                localStorage.setItem('french_learning_data', JSON.stringify(gData));
            } catch(e) {}
            
            if (!API) return;
            
            try {
                await fetch(API + "/save_data", { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(gData) 
                });
            } catch(e) {}
        }
        
        function addWord(w) {
            if (!gData.notebook.some(function(n) { return n.word === w; })) { 
                gData.notebook.push({ 
                    word: w, 
                    lvl: 0, 
                    next: new Date().toISOString().split('T')[0], 
                    err_days: 0 
                }); 
                speak("Ajoute");
                refreshUI();
            } else { 
                speak("Deja la"); 
            }
        }
        
        function setQuizMode(m) { 
            gGameMode = m; 
            var modeN = document.getElementById('mode-n');
            var modeR = document.getElementById('mode-r');
            if (modeN) modeN.classList.toggle('active', m === 'new');
            if (modeR) modeR.classList.toggle('active', m === 'rev');
            updateQuiz(); 
        }
        
        function updateQuiz() {
            const today = new Date().toISOString().split('T')[0];
            let pool = [];
            
            if (gGameMode === 'new') {
                pool = gTodayWords.filter(function(w) { 
                    return gData.notebook.some(function(n) { return n.word === w.word; }) && (sessionMastery[w.word] || 0) < MASTERY_GOAL;
                });
            } else {
                pool = DB.filter(function(v) { 
                    const n = gData.notebook.find(function(e) { return e.word === v.word; }); 
                    return n && n.next <= today && !gTodayWords.some(function(tw) { return tw.word === v.word; }) && (sessionMastery[v.word] || 0) < MASTERY_GOAL;
                });
            }
            
            var feedbackEl = document.getElementById('q-feedback');
            var optionsEl = document.getElementById('q-options');
            var wordEl = document.getElementById('q-word');
            var masteryEl = document.getElementById('q-mastery');
            
            if (feedbackEl) feedbackEl.innerText = "";
            gIsLocked = false;
            
            if (pool.length < 1) { 
                var isNew = gGameMode === 'new';
                var msg = isNew ? (gData.notebook.filter(function(n) { return gTodayWords.some(function(tw) { return tw.word === n.word; }); }).length < 5 ? "Ajoute les 5 mots du jour pour commencer !" : "Nouveaux mots maitrises !") : "Revisions terminees !";
                if (optionsEl) optionsEl.innerHTML = '<p style="padding:20px; color:var(--p); font-weight:bold; text-align:center;">' + msg + '</p>';
                if (wordEl) wordEl.innerText = "Salut !";
                if (masteryEl) masteryEl.innerHTML = "";
                return;
            }
            
            const target = pool[Math.floor(Math.random() * pool.length)];
            if (wordEl) wordEl.innerText = target.word;
            
            const mCount = sessionMastery[target.word] || 0;
            if (masteryEl) {
                var dots = '';
                for (var i = 0; i < MASTERY_GOAL; i++) {
                    dots += '<div class="dot ' + (i < mCount ? 'full' : '') + '"></div>';
                }
                masteryEl.innerHTML = dots;
            }
            
            let opts = [target.def];
            let all = DB.map(function(v) { return v.def; });
            while(opts.length < 3) {
                let r = all[Math.floor(Math.random() * all.length)];
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(function() { return Math.random() - 0.5; });
            
            if (optionsEl) {
                optionsEl.innerHTML = opts.map(function(o) {
                    return '<button class="opt-btn" onclick="checkQuiz(this, \'' + o.replace(/'/g, "\\'") + '\', \'' + target.word + '\')">' + o + '</button>';
                }).join('');
            }
        }
        
        function checkQuiz(btn, sel, w) {
            if (gIsLocked) return;
            gIsLocked = true;
            
            const target = DB.find(function(v) { return v.word === w; });
            const n = gData.notebook.find(function(e) { return e.word === w; });
            
            var feedbackEl = document.getElementById('q-feedback');
            var allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(function(b) { b.disabled = true; });
            
            if (sel === target.def) {
                btn.classList.add('correct');
                if (feedbackEl) {
                    feedbackEl.innerHTML = "Tres bien !";
                    feedbackEl.style.color = "var(--s)";
                }
                sessionMastery[w] = (sessionMastery[w] || 0) + 1;
                if (sessionMastery[w] >= MASTERY_GOAL && n) {
                    n.lvl = Math.min(6, n.lvl + 1);
                    n.err_days = 0;
                    let d = new Date();
                    d.setDate(d.getDate() + INTERVALS[n.lvl]);
                    n.next = d.toISOString().split('T')[0];
                }
                gCombo++;
                delete gMistakes[w];
                speak("Tres bien");
                setTimeout(function() { refreshUI(); }, 1000);
            } else {
                btn.classList.add('wrong');
                if (feedbackEl) {
                    feedbackEl.innerHTML = "Dommage !";
                    feedbackEl.style.color = "var(--e)";
                }
                sessionMastery[w] = 0;
                allBtns.forEach(function(b) { if(b.innerText === target.def) b.classList.add('correct'); });
                gCombo = 0;
                if (n) {
                    n.lvl = 0;
                    let d = new Date();
                    d.setDate(d.getDate() + 1);
                    n.next = d.toISOString().split('T')[0];
                    n.err_days = (n.err_days || 0) + 1;
                }
                speak("Dommage");
                setTimeout(function() { refreshUI(); }, 1800);
            }
        }
        
        function openNotebook() {
            renderNotebook();
            openModal('nbModal');
        }
        
        function renderNotebook(filterText) {
            var nbListEl = document.getElementById('nb-list');
            const today = new Date().toISOString().split('T')[0];
            
            if (!gData.notebook || gData.notebook.length === 0) {
                if (nbListEl) nbListEl.innerHTML = "<div class='nb-empty'>Ton carnet est vide.<br>Commence par ajouter des mots du jour !</div>";
                return;
            }
            
            let words = gData.notebook;
            if (filterText) {
                words = words.filter(function(n) { return n.word.toLowerCase().includes(filterText.toLowerCase()); });
            }
            
            var total = gData.notebook.length;
            var dueToday = gData.notebook.filter(function(n) { return n.next <= today; }).length;
            var withErrors = gData.notebook.filter(function(n) { return n.err_days > 0; }).length;
            
            var nbTotalEl = document.getElementById('nb-total');
            var nbStatsEl = document.getElementById('nb-stats');
            if (nbTotalEl) nbTotalEl.innerText = '(' + total + ' mots)';
            if (nbStatsEl) {
                nbStatsEl.innerHTML = '<div class="nb-stat"><div class="nb-stat-value">' + total + '</div><div>Total</div></div><div class="nb-stat"><div class="nb-stat-value" style="color:#f39c12">' + dueToday + '</div><div>A reviser</div></div><div class="nb-stat"><div class="nb-stat-value" style="color:#e74c3c">' + withErrors + '</div><div>Difficultes</div></div>';
            }
            
            if (nbListEl) {
                nbListEl.innerHTML = words.map(function(n) {
                    var w = DB.find(function(d) { return d.word === n.word; });
                    if (!w) return '';
                    var isDue = n.next <= today && !gTodayWords.some(function(tw) { return tw.word === n.word; });
                    var hasError = n.err_days > 0;
                    var dueClass = hasError ? 'nb-word-error' : (isDue ? 'nb-word-due' : '');
                    var dueBadge = isDue ? ' <span style="color:#f39c12;font-size="0.8em;">!</span>' : '';
                    var errorBadge = hasError ? ' <span style="color:#e74c3c;font-size:0.8em;">x' + n.err_days + '</span>' : '';
                    
                    return '<div class="notebook-item ' + dueClass + '" onclick="showDetail(\'' + n.word + '\')">' +
                        '<div style="display:flex;flex-direction:column;flex:1;">' +
                        '<span style="font-size:1.1em;"><strong>' + n.word + '</strong>' + dueBadge + errorBadge + '</span>' +
                        '<span style="font-size:0.85em;color:#666;margin-top:3px;">' + w.def.substring(0, 50) + '...</span>' +
                        '<span style="font-size:0.75em;color:#999;margin-top:2px;">Prochaine: ' + n.next + '</span>' +
                        '</div>' +
                        '<div style="display:flex;align-items:center;gap:8px;">' +
                        '<span class="lvl-badge">Lvl ' + n.lvl + '</span>' +
                        '<button onclick="event.stopPropagation(); speak(\'' + n.word + '\')" style="background:var(--s);border:none;width:35px;height:35px;border-radius:50%;color:white;font-size:1.2em;cursor:pointer;">&#128266;</button>' +
                        '</div></div>';
                }).join('');
            }
        }
        
        function filterNotebook() {
            var searchEl = document.getElementById('nb-search');
            if (searchEl) {
                renderNotebook(searchEl.value.trim());
            }
        }
        
        function showDetail(w) {
            var d = DB.find(function(v) { return v.word === w; });
            if (!d) return;
            var detailCard = document.getElementById('detail-card');
            if (detailCard) {
                detailCard.innerHTML = '<h2>' + d.word + '</h2><p><strong>Definition:</strong><br>' + d.def + '</p><p><strong>Exemple:</strong><br><i>"' + d.ex + '"</i></p><button class="action-btn" style="width:100%;margin-top:20px" onclick="speak(\'' + d.word + '\')">Ecouter</button>';
            }
            openModal('detailModal');
            speak(w);
        }
        
        function openModal(id) {
            var el = document.getElementById(id);
            if (el) el.style.display = "block";
        }
        
        function closeModal(id) {
            var el = document.getElementById(id);
            if (el) el.style.display = "none";
        }
        
        function speak(t) {
            try {
                var m = new SpeechSynthesisUtterance(t);
                m.lang = 'fr-FR';
                window.speechSynthesis.speak(m);
            } catch(e) {}
        }
        
        window.onclick = function(e) {
            if (e.target.className === 'modal') e.target.style.display = "none";
        };
        
        window.onload = init;
    </script>
</body>
</html>
