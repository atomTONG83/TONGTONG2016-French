<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üíé Le Tr√©sor des Mots de Jingyi</title>
    <style>
        :root { --p: #3498db; --s: #2ecc71; --e: #e74c3c; --w: #f1c40f; --d: #2c3e50; --rv: #9b59b6; }
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .stats-bar { display: flex; justify-content: space-around; background: white; padding: 15px; border-radius: 50px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-item { font-weight: bold; font-size: 1.1em; }
        .daily-goal-box { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .progress-container { width: 100%; background: #eee; height: 18px; border-radius: 10px; margin-top: 10px; overflow: hidden; display: flex; border: 1px solid #ddd; }
        .bar { height: 100%; transition: width 0.5s; }
        .bar-new { background: var(--p); border-right: 2px solid white; } .bar-rev { background: var(--rv); }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        .mot { font-size: 2.2em; color: var(--p); font-weight: bold; margin: 5px 0; }
        .definition { margin: 10px 0; font-size: 1.05em; line-height: 1.5; color: #444; }
        .exemple { background: #f9f9f9; padding: 12px; border-left: 5px solid var(--p); border-radius: 0 10px 10px 0; font-size: 1em; margin: 10px 0; font-style: italic; color: #666; }
        .daily-item { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 20px; }
        .daily-item:last-child { border-bottom: none; }
        .game-zone { background: #fffbe6; border: 2px dashed var(--w); }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 20px; }
        .opt-btn { background: white; border: 2px solid #ddd; padding: 18px; border-radius: 12px; cursor: pointer; text-align: left; font-size: 1.05em; width: 100%; transition: all 0.2s; outline: none; -webkit-tap-highlight-color: transparent; }
        .opt-btn:hover:not(:disabled) { border-color: #ddd; background: white; }
        .opt-btn:focus { outline: none; }
        .correct { background: var(--s) !important; color: white !important; border-color: var(--s) !important; }
        .wrong { background: var(--e) !important; color: white !important; border-color: var(--e) !important; }
        button.action-btn { background: var(--s); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.95em; }
        .lvl-badge { font-size: 0.7em; background: #eee; padding: 2px 8px; border-radius: 5px; color: #666; margin-left: 5px; }
        .mode-btn { border: none; padding: 8px 16px; border-radius: 10px; cursor: pointer; font-weight: bold; background: #eee; color: #666; position: relative; }
        .mode-btn.active { background: var(--p); color: white; }
        .mode-btn.done::after { content: "‚úÖ"; position: absolute; top: -5px; right: -5px; font-size: 0.8em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 15% auto; padding: 30px; border-radius: 20px; width: 85%; max-width: 550px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close { position: absolute; right: 20px; top: 15px; font-size: 32px; cursor: pointer; color: #bbb; }
        #sync-status { position: fixed; bottom: 10px; right: 10px; font-size: 0.75em; color: white; background: #999; padding: 6px 12px; border-radius: 8px; z-index: 2000; }
        .notebook-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: white; margin-bottom: 5px; border-radius: 10px; }
        .mastery-indicator { display: flex; gap: 5px; margin-top: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ddd; border: 1px solid #ccc; }
        .dot.full { background: var(--s); border-color: var(--s); }
        /* Notebook grouping styles */
        .nb-group { margin-bottom: 15px; border-radius: 12px; overflow: hidden; }
        .nb-group-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 15px; cursor: pointer; font-weight: bold;
            transition: all 0.2s;
        }
        .nb-group-header:hover { opacity: 0.9; }
        .nb-group-count { 
            background: rgba(255,255,255,0.3); 
            padding: 2px 10px; border-radius: 20px; 
            font-size: 0.85em;
        }
        .nb-group-content { max-height: 300px; overflow-y: auto; }
        .nb-group-content.collapsed { display: none; }
        .nb-beginner { background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%); color: white; }
        .nb-consolidating { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: white; }
        .nb-advanced { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; }
        .nb-mastered { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; }
        .nb-search { 
            width: 100%; padding: 12px 15px; border: 2px solid #ddd; 
            border-radius: 25px; font-size: 1em; margin-bottom: 15px;
            box-sizing: border-box;
        }
        .nb-search:focus { outline: none; border-color: var(--p); }
        .nb-stats { 
            display: flex; justify-content: space-around; 
            padding: 10px; background: #f8f9fa; border-radius: 10px; 
            margin-bottom: 15px; font-size: 0.9em;
        }
        .nb-stat { text-align: center; }
        .nb-stat-value { font-weight: bold; color: var(--p); font-size: 1.2em; }
        .nb-empty { text-align: center; padding: 30px; color: #999; }
        .nb-word-due { background: #fff3cd !important; border-left: 4px solid #ffc107 !important; }
        .nb-word-error { background: #f8d7da !important; border-left: 4px solid #dc3545 !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="text-align: left; margin-bottom: 10px;">
                <a href="index.html" style="text-decoration: none; color: var(--p); font-weight: bold; font-size: 0.9em;">‚Üê Retour</a>
            </div>
            <h1>üíé Le Tr√©sor des Mots de Jingyi <span class="lvl-badge" style="background:var(--w); color:black; padding:6px 12px; font-size:0.5em;">CM1</span></h1>
            <p id="ui-date" style="font-weight: bold; color: var(--p); font-size: 1.1em; margin: 10px 0;"></p>
            <p style="color: #666; font-size: 0.9em;">Mission : Ma√Ætrise tous les mots !</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">‚≠ê <span id="ui-stars">0</span> Stars</div>
            <div class="stat-item">üèÜ <span id="ui-trophies">0</span> Troph√©es</div>
            <div class="stat-item" onclick="openNotebook()" style="cursor: pointer; color: var(--p); text-decoration: underline;">üìì <span id="ui-count">0</span> Mots</div>
        </div>

        <div class="daily-goal-box">
            <div style="display: flex; justify-content: space-between; font-size: 0.9em;">
                <strong>üéØ Progr√®s : <span style="color:var(--p)">Nouveaux</span> + <span style="color:var(--rv)">R√©vision</span></strong>
                <span id="ui-progress">0%</span>
            </div>
            <div class="progress-container"><div class="bar bar-new" id="bar-n"></div><div class="bar bar-rev" id="bar-r"></div></div>
            <div id="ui-completion-status" style="text-align:center; margin-top:5px; font-weight:bold; font-size:0.9em;"></div>
        </div>

        <div class="card">
            <h2>üåü Mots du Jour</h2>
            <div id="ui-words-list"></div>
        </div>

        <div class="card game-zone">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üéÆ D√©fi</h2>
                <div style="display:flex; gap:8px;">
                    <button id="mode-n" class="mode-btn active" onclick="setQuizMode('new')">Nouveaux</button>
                    <button id="mode-r" class="mode-btn" onclick="setQuizMode('rev')">R√©vision</button>
                </div>
            </div>
            <p style="font-size:0.85em;color:#666;margin:0 0 10px 0;font-style:italic;">üí° R√®gle : R√©ponds correctement 2 fois de suite pour ma√Ætriser un mot et gagner +100‚≠ê !</p>
            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                <p>D√©finition de <strong id="q-word" style="color:var(--p)">?</strong></p>
                <div id="q-mastery" class="mastery-indicator"></div>
            </div>
            <div id="q-options" class="options-grid"></div>
            <p id="q-feedback" style="margin-top: 15px; font-weight: bold; text-align: center; font-size: 1.2em; min-height: 1.2em;"></p>
        </div>

        <div class="card" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div><h3 style="font-size:0.9em;color:var(--p)">‚úÖ Appris</h3><div id="list-new"></div></div>
            <div><h3 style="font-size:0.9em;color:var(--rv)">‚è≥ Mission</h3><div id="list-due"></div></div>
        </div>
    </div>

    <div id="sync-status">Initialisation...</div>

    <div id="nbModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('nbModal')">&times;</span>
            <h2>üìì Mon Carnet <span id="nb-total" style="font-size:0.6em;color:#999;font-weight:normal;"></span></h2>
            <div class="nb-stats" id="nb-stats"></div>
            <input type="text" class="nb-search" id="nb-search" placeholder="üîç Rechercher un mot..." oninput="filterNotebook()">
            <div id="nb-list"></div>
        </div>
    </div>
    <div id="detailModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('detailModal')">&times;</span><div id="detail-card"></div></div></div>
    <div id="rewardModal" class="modal"><div class="modal-content" style="text-align:center;"><h2>üéÅ BRAVO !</h2><p id="rew-val"></p><button class="action-btn" onclick="closeModal('rewardModal')">Merci Papa !</button></div></div>

    <script>
        const MAC_IP = "192.168.32.70";
        const PORT = "8888";
        // API address - detect if running on Mac mini or remote
        const isLocal = (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1" || window.location.hostname === MAC_IP || window.location.hostname === "TONGdeMac-mini.local");
        const API = isLocal ? `http://${window.location.hostname}:${PORT}` : `http://${MAC_IP}:${PORT}`;
        // For GitHub Pages and Local, we use relative paths for data
        const DATA_PATH = "./french_data.json";
        
        let gData = { stars: 100, notebook: [], daily_stats: { date: "", completed: false, words: [] }, last_milestone: 0 };
        let sessionMastery = {}; 
        let gTodayWords = [], gGameMode = 'new', gMistakes = {}, gCombo = 0, gIsLocked = false;
        const INTERVALS = [1, 2, 4, 7, 15, 30, 60];
        const MASTERY_GOAL = 2;

        const DB = [
            // === NIVEAU CE2 (R√©vision) - 20 mots ===
            { word: "Maison", def: "B√¢timent o√π l'on habite.", ex: "Ma maison est grande." },
            { word: "√âcole", def: "Lieu o√π l'on apprend.", ex: "Je vais √† l'√©cole." },
            { word: "Famille", def: "Groupe de personnes parents et enfants.", ex: "Ma famille est nombreuse." },
            { word: "Jardin", def: "Terrain o√π l'on cultive des plantes.", ex: "Il y a des fleurs dans le jardin." },
            { word: "Table", def: "Meuble sur lequel on mange ou travaille.", ex: "Mets le livre sur la table." },
            { word: "Chaise", def: "Si√®ge avec un dossier.", ex: "Assieds-toi sur la chaise." },
            { word: "Livre", def: "Objet avec des pages √©crites.", ex: "Je lis un livre int√©ressant." },
            { word: "Crayon", def: "Instrument pour √©crire en bois.", ex: "J'√©cris avec un crayon." },
            { word: "Fen√™tre", def: "Ouverture dans un mur pour voir dehors.", ex: "Regarde par la fen√™tre." },
            { word: "Porte", def: "Ouverture pour entrer ou sortir.", ex: "Ferme la porte s'il te pla√Æt." },
            { word: "Chien", def: "Animal domestique fid√®le.", ex: "Mon chien s'appelle Max." },
            { word: "Chat", def: "Animal domestique qui miaule.", ex: "Le chat dort sur le canap√©." },
            { word: "Soleil", def: "√âtoile qui √©claire la Terre.", ex: "Le soleil brille aujourd'hui." },
            { word: "Lune", def: "Satellite naturel de la Terre.", ex: "La lune est ronde ce soir." },
            { word: "√âtoile", def: "Corps c√©leste qui brille la nuit.", ex: "Les √©toiles sont belles." },
            { word: "Arbre", def: "Plante avec un tronc et des branches.", ex: "L'oiseau est dans l'arbre." },
            { word: "Fleur", def: "Partie color√©e d'une plante.", ex: "Cette fleur sent bon." },
            { word: "Rivi√®re", def: "Cours d'eau naturel.", ex: "On se baigne dans la rivi√®re." },
            { word: "Montagne", def: "Grande √©l√©vation de terrain.", ex: "On grimpe la montagne." },
            { word: "Mer", def: "Grande √©tendue d'eau sal√©e.", ex: "La mer est bleue." },
            
            // === NIVEAU CM1 (Principal) - 140 mots ===
            // Qualit√©s et sentiments (20)
            { word: "Pers√©v√©rance", def: "Action de continuer malgr√© les difficult√©s.", ex: "Jingyi montre une grande pers√©v√©rance." },
            { word: "Bienveillance", def: "Disposition √† vouloir le bien d'autrui.", ex: "La ma√Ætresse agit avec bienveillance." },
            { word: "Curiosit√©", def: "D√©sir de savoir ou d'apprendre.", ex: "La curiosit√© est une qualit√© pr√©cieuse." },
            { word: "Fraternit√©", def: "Lien de solidarit√© entre les humains.", ex: "La fraternit√© est une valeur importante." },
            { word: "Imagination", def: "Facult√© de cr√©er des id√©es nouvelles.", ex: "Jingyi a une imagination d√©bordante." },
            { word: "Sinc√©rit√©", def: "Qualit√© de celui qui dit la v√©rit√©.", ex: "L'amiti√© demande de la sinc√©rit√©." },
            { word: "G√©n√©rosit√©", def: "Aimer donner et partager.", ex: "Elle fait preuve de g√©n√©rosit√©." },
            { word: "Honn√™tet√©", def: "Ne pas mentir ni voler.", ex: "L'honn√™tet√© est essentielle." },
            { word: "Courage", def: "Force morale pour affronter le danger.", ex: "Il faut du courage pour parler." },
            { word: "Patience", def: "Capacit√© d'attendre sans s'√©nerver.", ex: "La patience est une vertu." },
            { word: "Respect", def: "Consid√©ration pour les autres.", ex: "Il faut respecter les autres." },
            { word: "Tol√©rance", def: "Acceptation des diff√©rences.", ex: "La tol√©rance permet de vivre ensemble." },
            { word: "Empathie", def: "Compr√©hension des sentiments d'autrui.", ex: "L'empathie nous rapproche." },
            { word: "Gratitude", def: "Reconnaissance pour un bienfait.", ex: "Je te exprime ma gratitude." },
            { word: "Humilit√©", def: "Modestie dans le comportement.", ex: "L'humilit√© est une belle qualit√©." },
            { word: "Optimisme", def: "Tendance √† voir le bon c√¥t√©.", ex: "Son optimisme est contagieux." },
            { word: "D√©termination", def: "Volont√© ferme d'agir.", ex: "Sa d√©termination paie." },
            { word: "Responsabilit√©", def: "Obligation de r√©pondre de ses actes.", ex: "Prends tes responsabilit√©s." },
            { word: "Solidarit√©", def: "Entraide entre les membres d'un groupe.", ex: "La solidarit√© nous rend plus forts." },
            { word: "√âmerveillement", def: "√âtat de grande admiration.", ex: "L'√©merveillement des enfants est touchant." },
            
            // Sciences naturelles (25)
            { word: "√âcosyst√®me", def: "√ätres vivants et leur milieu.", ex: "La for√™t est un √©cosyst√®me." },
            { word: "Biodiversit√©", def: "Diversit√© des esp√®ces vivantes.", ex: "Prot√©geons la biodiversit√©." },
            { word: "Atmosph√®re", def: "La couche d'air qui entoure la Terre.", ex: "L'atmosph√®re nous prot√®ge." },
            { word: "Photosynth√®se", def: "Processus par lequel les plantes cr√©ent leur nourriture.", ex: "La photosynth√®se rejette de l'oxyg√®ne." },
            { word: "Mammif√®re", def: "Animal dont la femelle allaite ses petits.", ex: "Le chien est un mammif√®re." },
            { word: "Pollinisation", def: "Transport du pollen pour les fleurs.", ex: "L'abeille aide √† la pollinisation." },
            { word: "Pr√©cipitations", def: "Formes d'eau qui tombent du ciel.", ex: "Le champ attend les pr√©cipitations." },
            { word: "√ârosion", def: "Usure de la Terre par le vent ou l'eau.", ex: "L'√©rosion sculpte les falaises." },
            { word: "Astronomie", def: "Science qui √©tudie les astres.", ex: "L'astronomie √©tudie les plan√®tes." },
            { word: "Microscope", def: "Instrument pour voir des objets minuscules.", ex: "On voit des cellules au microscope." },
            { word: "√âlectricit√©", def: "√ânergie produite par des particules.", ex: "L'√©lectricit√© √©claire la maison." },
            { word: "√âvaporisation", def: "Passage d'un liquide √† l'√©tat de vapeur.", ex: "Le soleil √©vapore l'eau." },
            { word: "Condensation", def: "Passage d'une vapeur √† l'√©tat liquide.", ex: "La bu√©e est de la condensation." },
            { word: "Reptile", def: "Animal √† sang froid avec des √©cailles.", ex: "Le l√©zard est un reptile." },
            { word: "Amphibien", def: "Animal vivant dans l'eau et sur terre.", ex: "La grenouille est un amphibien." },
            { word: "Vert√®bre", def: "Animal avec une colonne vert√©brale.", ex: "L'homme est un vert√®bre." },
            { word: "Insecte", def: "Petit animal √† six pattes.", ex: "La fourmi est un insecte." },
            { word: "S√©diment", def: "D√©p√¥t de mati√®re transport√©e par l'eau.", ex: "Les s√©diments forment des roches." },
            { word: "Volcan", def: "Montagne qui projette de la lave.", ex: "Le volcan entre en √©ruption." },
            { word: "S√©isme", def: "Tremblement de terre.", ex: "Le s√©isme a secou√© la ville." },
            { word: "Orbit", def: "Trajectoire d'un astre autour d'un autre.", ex: "La Terre est en orbite autour du Soleil." },
            { word: "Galaxie", def: "Ensemble d'√©toiles, de gaz et de poussi√®re.", ex: "Nous vivons dans la galaxie Voie lact√©e." },
            { word: "M√©t√©orite", def: "Fragment de roche venant de l'espace.", ex: "Une m√©t√©orite est tomb√©e sur Terre." },
            { word: "Fossile", def: "Trace d'un animal ou d'une plante ancienne.", ex: "On a trouv√© un fossile de dinosaure." },
            { word: "Chromatographie", def: "Technique pour s√©parer des m√©langes.", ex: "La chromatographie s√©pare les couleurs." },
            
            // Histoire et g√©ographie (25)
            { word: "Antiquit√©", def: "P√©riode commen√ßant avec l'√©criture.", ex: "Les pyramides datent de l'Antiquit√©." },
            { word: "Moyen √Çge", def: "P√©riode entre l'Antiquit√© et la Moderne.", ex: "On vivait dans des ch√¢teaux au Moyen √Çge." },
            { word: "Renaissance", def: "P√©riode de renouveau des arts.", ex: "Vinci est un artiste de la Renaissance." },
            { word: "Continent", def: "Une des grandes √©tendues de terre du globe.", ex: "L'Europe est un continent." },
            { word: "Archipel", def: "Groupe d'√Æles proches sur la mer.", ex: "Le Japon est un archipel." },
            { word: "D√©mocratie", def: "Syst√®me o√π le peuple exerce le pouvoir.", ex: "On vote en d√©mocratie." },
            { word: "Monarchie", def: "Pouvoir d√©tenu par un roi.", ex: "Le roi dirige la monarchie." },
            { word: "Fronti√®re", def: "Ligne qui s√©pare deux pays.", ex: "On traverse la fronti√®re." },
            { word: "Civilisation", def: "√âtat de d√©veloppement d'une soci√©t√©.", ex: "La civilisation √©gyptienne est ancienne." },
            { word: "R√©volution", def: "Changement brusque dans l'organisation politique.", ex: "La R√©volution fran√ßaise a chang√© la France." },
            { word: "Empire", def: "√âtat dirig√© par un empereur.", ex: "Napol√©on a fond√© un empire." },
            { word: "Colonie", def: "Territoire domin√© par un pays √©tranger.", ex: "L'Alg√©rie √©tait une colonie fran√ßaise." },
            { word: "Ind√©pendance", def: "√âtat d'un pays qui se gouverne seul.", ex: "L'ind√©pendance a √©t√© proclam√©e en 1962." },
            { word: "Trait", def: "Accord sign√© entre plusieurs pays.", ex: "Un trait de paix a √©t√© sign√©." },
            { word: "Alliance", def: "Union entre plusieurs pays ou groupes.", ex: "Les deux pays ont form√© une alliance." },
            { word: "Invasion", def: "Entr√©e militaire dans un pays.", ex: "L'invasion a commenc√© au printemps." },
            { word: "Patrimoine", def: "Biens h√©rit√©s des g√©n√©rations pass√©es.", ex: "Notre patrimoine doit √™tre pr√©serv√©." },
            { word: "Arch√©ologie", def: "√âtude des civilisations anciennes.", ex: "L'arch√©ologie r√©v√®le notre pass√©." },
            { word: "Pr√©histoire", def: "P√©riode avant l'√©criture.", ex: "Les hommes pr√©historiques vivaient dans des grottes." },
            { word: "D√©sert", def: "R√©gion tr√®s s√®che avec peu de v√©g√©tation.", ex: "Le Sahara est un grand d√©sert." },
            { word: "P√©ninsule", def: "Terre entour√©e d'eau presque partout.", ex: "L'Italie est une p√©ninsule." },
            { word: "Cap", def: "Pointe de terre avan√ßant dans la mer.", ex: "Le Cap Horn est c√©l√®bre." },
            { word: "D√©troit", def: "Passage √©troit entre deux mers.", ex: "Le d√©troit de Gibraltar relie deux mers." },
            { word: "Vall√©e", def: "√âtendue de terre entre des montagnes.", ex: "La vall√©e est fertile." },
            { word: "Glacier", def: "Masse de glace qui descend d'une montagne.", ex: "Le glacier fond √† cause du r√©chauffement." },
            
            // Litt√©rature et arts (20)
            { word: "Litt√©rature", def: "Ensemble des ≈ìuvres √©crites.", ex: "On lit de la litt√©rature." },
            { word: "M√©taphore", def: "Image utilisant un mot pour un autre.", ex: "'C≈ìur de pierre' est une m√©taphore." },
            { word: "Portrait", def: "Description d'une personne.", ex: "L'auteur fait un portrait d√©taill√©." },
            { word: "Symphonie", def: "Grande ≈ìuvre pour orchestre.", ex: "Une symphonie de Mozart." },
            { word: "Perspective", def: "Profondeur dans un dessin.", ex: "Il dessine en perspective." },
            { word: "Protagoniste", def: "Personnage principal d'histoire.", ex: "Le protagoniste gagne √† la fin." },
            { word: "Manuscrit", def: "Texte √©crit √† la main.", ex: "Un vieux manuscrit a √©t√© d√©couvert." },
            { word: "All√©gorie", def: "Repr√©sentation concr√®te d'une id√©e.", ex: "La colombe est l'all√©gorie de la paix." },
            { word: "R√©cit", def: "Histoire racont√©e.", ex: "Le r√©cit est passionnant." },
            { word: "Narrateur", def: "Celui qui raconte l'histoire.", ex: "Le narrateur parle √† la premi√®re personne." },
            { word: "Intrigue", def: "Encha√Ænement des √©v√©nements d'une histoire.", ex: "L'intrigue est complexe." },
            { word: "Climax", def: "Moment le plus intense d'une histoire.", ex: "Le climax arrive au chapitre 10." },
            { word: "D√©nouement", def: "Fin d'une histoire.", ex: "Le d√©nouement est surprenant." },
            { word: "Strophe", def: "Groupe de vers dans un po√®me.", ex: "Ce po√®me a quatre strophes." },
            { word: "Rime", def: "Ressemblance de sons √† la fin des vers.", ex: "'Chat' et 'mat' font rime." },
            { word: "Palette", def: "Planche pour m√©langer les couleurs.", ex: "L'artiste tient sa palette." },
            { word: "Sculpture", def: "≈íuvre d'art en trois dimensions.", ex: "La sculpture est en marbre." },
            { word: "Architecture", def: "Art de construire les b√¢timents.", ex: "L'architecture gothique est √©l√©gante." },
            { word: "Chor√©graphie", def: "Suite de mouvements de danse.", ex: "La chor√©graphie est difficile." },
            { word: "Op√©ra", def: "Spectacle chant√© avec orchestre.", ex: "On va voir un op√©ra ce soir." },
            
            // Sciences et technologie (25)
            { word: "Technologie", def: "Outils et machines invent√©s par l'homme.", ex: "L'ordinateur est une technologie moderne." },
            { word: "Exp√©rience", def: "Test pour v√©rifier une id√©e.", ex: "On fait une exp√©rience en classe." },
            { word: "Hypoth√®se", def: "Id√©e propos√©e avant d'√™tre v√©rifi√©e.", ex: "Le scientifique √©met une hypoth√®se." },
            { word: "Robot", def: "Machine programmable pour faire des t√¢ches.", ex: "Le robot assemble les pi√®ces." },
            { word: "Satellite", def: "Objet artificiel en orbite.", ex: "Le satellite transmet des images." },
            { word: "√ânergie", def: "Capacit√© √† produire un travail.", ex: "Le soleil fournit de l'√©nergie." },
            { word: "R√©seau", def: "Ensemble de connexions.", ex: "Internet est un r√©seau mondial." },
            { word: "Programme", def: "Suite d'instructions pour un ordinateur.", ex: "Le programme calcule rapidement." },
            { word: "Donn√©es", def: "Informations trait√©es par un ordinateur.", ex: "Les donn√©es sont stock√©es dans le cloud." },
            { word: "Interface", def: "Surface de contact entre deux syst√®mes.", ex: "L'interface est facile √† utiliser." },
            { word: "Capteur", def: "Dispositif d√©tectant des ph√©nom√®nes physiques.", ex: "Le capteur mesure la temp√©rature." },
            { word: "Moteur", def: "Machine transformant l'√©nergie en mouvement.", ex: "Le moteur de la voiture tourne." },
            { word: "Turbine", def: "Machine mise en rotation par un fluide.", ex: "La turbine produit de l'√©lectricit√©." },
            { word: "R√©action", def: "Transformation chimique entre substances.", ex: "La r√©action produit de la chaleur." },
            { word: "Mol√©cule", def: "Plus petite partie d'un corps simple.", ex: "Une mol√©cule d'eau a deux atomes d'hydrog√®ne." },
            { word: "Atome", def: "Plus petite partie d'un corps simple.", ex: "Un atome est tr√®s petit." },
            { word: "Gravit√©", def: "Force d'attraction terrestre.", ex: "La gravit√© nous maintient au sol." },
            { word: "Vitesse", def: "Rapidit√© d'un mouvement.", ex: "La vitesse est de 100 km/h." },
            { word: "Acc√©l√©ration", def: "Augmentation de la vitesse.", ex: "L'acc√©l√©ration est rapide." },
            { word: "Friction", def: "R√©sistance au mouvement entre deux surfaces.", ex: "La friction ralentit le glissement." },
            { word: "√âquilibre", def: "√âtat d'un corps qui ne tombe pas.", ex: "L'√©quilibre est difficile √† maintenir." },
            { word: "Circuit", def: "Chemin suivi par un courant √©lectrique.", ex: "Le circuit est ferm√©." },
            { word: "R√©sistance", def: "Opposition au passage du courant.", ex: "La r√©sistance limite le courant." },
            { word: "Conducteur", def: "Mati√®re laissant passer le courant.", ex: "Le cuivre est un bon conducteur." },
            { word: "Isolant", def: "Mati√®re ne laissant pas passer le courant.", ex: "Le caoutchouc est un isolant." },
            
            // Animaux (25)
            { word: "Girafe", def: "Animal au long cou et aux taches.", ex: "La girafe mange les feuilles hautes." },
            { word: "√âl√©phant", def: "Grand animal avec une trompe.", ex: "L'√©l√©phant est le plus grand animal terrestre." },
            { word: "M√©duses", def: "Animal marin transparent avec des tentacules.", ex: "Attention aux m√©duses dans l'eau." },
            { word: "Chauve-souris", def: "Petit mammif√®re volant la nuit.", ex: "La chauve-souris chasse les moustiques." },
            { word: "Dauphin", def: "Mammif√®re marin tr√®s intelligent.", ex: "Le dauphin nage gracieusement." },
            { word: "Hippopotame", def: "Grand animal semi-aquatique.", ex: "L'hippopotame vit pr√®s de l'eau." },
            { word: "Rhinoc√©ros", def: "Animal avec une corne sur le nez.", ex: "Le rhinoc√©ros est menac√© d'extinction." },
            { word: "Kangourou", def: "Animal australien qui saute.", ex: "Le kangourou porte son b√©b√© dans une poche." },
            { word: "Panda", def: "Ours noir et blanc mangeant du bambou.", ex: "Le panda vit en Chine." },
            { word: "Tigre", def: "Grand f√©lin ray√©.", ex: "Le tigre est un chasseur redoutable." },
            { word: "Lion", def: "Grand f√©lin avec une crini√®re.", ex: "Le lion est le roi des animaux." },
            { word: "Z√®bre", def: "Animal avec des rayures noires et blanches.", ex: "Le z√®bre vit dans la savane." },
            { word: "Pingouin", def: "Oiseau marin ne volant pas.", ex: "Le pingouin vit dans l'Antarctique." },
            { word: "Aigle", def: "Grand oiseau de proie.", ex: "L'aigle vole haut dans le ciel." },
            { word: "Hibou", def: "Oiseau nocturne avec de grands yeux.", ex: "Le hibou chasse la nuit." },
            { word: "Cygne", def: "Grand oiseau blanc √† long cou.", ex: "Le cygne glisse sur l'eau." },
            { word: "Paon", def: "Oiseau avec une queue color√©e.", ex: "Le paon d√©ploie ses plumes." },
            { word: "Tortue", def: "Reptile avec une carapace dure.", ex: "La tortue vit longtemps." },
            { word: "Crocodile", def: "Grand reptile avec de grandes dents.", ex: "Le crocodile vit dans les rivi√®res." },
            { word: "Cam√©l√©on", def: "Animal qui change de couleur.", ex: "Le cam√©l√©on s'adapte √† son environnement." },
            { word: "Papillon", def: "Insecte avec des ailes color√©es.", ex: "Le papillon vole de fleur en fleur." },
            { word: "Abeille", def: "Insecte qui fait du miel.", ex: "L'abeille butine les fleurs." },
            { word: "Coccinelle", def: "Petit insecte rouge √† points noirs.", ex: "La coccinelle mange les pucerons." },
            { word: "Araign√©e", def: "Animal √† huit pattes tissant des toiles.", ex: "L'araign√©e tisse sa toile." },
            { word: "Escargot", def: "Animal lent avec une coquille.", ex: "L'escargot laisse une trace de bave." },
            
            // === NIVEAU CM2 (Avanc√©) - 40 mots ===
            { word: "Philosophie", def: "R√©flexion sur les grandes questions.", ex: "La philosophie nous aide √† r√©fl√©chir." },
            { word: "D√©mographie", def: "√âtude des populations.", ex: "La d√©mographie √©tudie la croissance." },
            { word: "Globalisation", def: "Int√©gration √©conomique mondiale.", ex: "La globalisation connecte les pays." },
            { word: "Sustainabilit√©", def: "Capacit√© √† durer sans s'√©puiser.", ex: "La durabilit√© est essentielle pour la plan√®te." },
            { word: "Biotechnologie", def: "Utilisation des √™tres vivants pour la technologie.", ex: "La biotechnologie cr√©e des m√©dicaments." },
            { word: "Nanotechnologie", def: "Technologie √† l'√©chelle des atomes.", ex: "La nanotechnologie r√©volutionne la m√©decine." },
            { word: "Intelligence", def: "Capacit√© √† comprendre et apprendre.", ex: "L'intelligence artificielle simule l'esprit." },
            { word: "Conscience", def: "Connaissance de soi et de son environnement.", ex: "La conscience nous distingue des animaux." },
            { word: "M√©moire", def: "Capacit√© √† conserver des informations.", ex: "La m√©moire d√©cline avec l'√¢ge." },
            { word: "Perception", def: "Mani√®re de voir ou comprendre les choses.", ex: "La perception varie selon les gens." },
            { word: "Cognition", def: "Processus de connaissance et de pens√©e.", ex: "La cognition inclut l'attention et la m√©moire." },
            { word: "Neuroscience", def: "√âtude du syst√®me nerveux.", ex: "Les neurosciences expliquent le cerveau." },
            { word: "G√©n√©tique", def: "√âtude de l'h√©r√©dit√©.", ex: "La g√©n√©tique √©tudie les g√®nes." },
            { word: "Mutation", def: "Changement dans l'ADN.", ex: "La mutation peut √™tre b√©n√©fique ou nuisible." },
            { word: "√âvolution", def: "Transformation progressive des esp√®ces.", ex: "L'√©volution a cr√©√© la biodiversit√©." },
            { word: "S√©lection", def: "Choix des meilleurs individus.", ex: "La s√©lection naturelle favorise l'adaptation." },
            { word: "Extinction", def: "Disparition d'une esp√®ce.", ex: "L'extinction des dinosaures est myst√©rieuse." },
            { word: "Conservation", def: "Protection de la nature.", ex: "La conservation des esp√®ces est urgente." },
            { word: "Restauration", def: "Action de r√©parer.", ex: "La restauration des ≈ìuvres d'art est d√©licate." },
            { word: "Pr√©servation", def: "Maintien dans un bon √©tat.", ex: "La pr√©servation de l'environnement est cruciale." },
            { word: "Restauration", def: "Action de r√©parer.", ex: "La restauration des monuments prend du temps." },
            { word: "H√©ritage", def: "Ce que l'on transmet aux g√©n√©rations futures.", ex: "Notre h√©ritage culturel est pr√©cieux." },
            { word: "Tradition", def: "Coutume transmise de g√©n√©ration en g√©n√©ration.", ex: "La tradition se perp√©tue." },
            { word: "Innovation", def: "Introduction de quelque chose de nouveau.", ex: "L'innovation pousse la soci√©t√© en avant." },
            { word: "Cr√©ativit√©", def: "Capacit√© √† cr√©er de nouvelles choses.", ex: "La cr√©ativit√© est essentielle en art." },
            { word: "Esth√©tique", def: "√âtude de la beaut√©.", ex: "L'esth√©tique de ce tableau est remarquable." },
            { word: "Harmonie", def: "Accord parfait des sons ou des couleurs.", ex: "L'harmonie des couleurs est apaisante." },
            { word: "Sym√©trie", def: "Correspondance exacte des deux c√¥t√©s.", ex: "La sym√©trie est belle en architecture." },
            { word: "Proportion", def: "Rapport entre les dimensions.", ex: "Les proportions du visage sont id√©ales." },
            { word: "Perspective", def: "Mani√®re de voir les choses.", ex: "Chaque personne a sa perspective." },
            { word: "Contexte", def: "Ensemble des circonstances.", ex: "Il faut comprendre le contexte historique." },
            { word: "Interpr√©tation", def: "Explication ou traduction d'un texte.", ex: "L'interpr√©tation du po√®me varie." },
            { word: "Analyse", def: "Examen d√©taill√©.", ex: "L'analyse du texte r√©v√®le des symboles." },
            { word: "Synth√®se", def: "Combinaison en un tout coh√©rent.", ex: "La synth√®se des id√©es est claire." },
            { word: "Argumentation", def: "Ensemble des arguments.", ex: "L'argumentation est convaincante." },
            { word: "Rh√©torique", def: "Art de persuader par la parole.", ex: "La rh√©torique ancienne est sophistiqu√©e." },
            { word: "Dialectique", def: "M√©thode de discussion par questions.", ex: "La dialectique socratique questionne tout." },
            { word: "Paradoxe", def: "Id√©e contraire √† l'opinion commune.", ex: "C'est un paradoxe int√©ressant." },
            { word: "Analogie", def: "Comparaison entre deux choses.", ex: "L'analogie √©claire le concept." },
            { word: "Dichotomie", def: "Division en deux parties oppos√©es.", ex: "La dichotomie bien/mal est simpliste." }
        ];

        async function init() {
            document.getElementById('ui-date').innerText = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const response = await fetch(`${DATA_PATH}?t=${Date.now()}`);
                const localSaved = localStorage.getItem('french_learning_data');
                const localData = localSaved ? JSON.parse(localSaved) : null;

                if (response.ok) {
                    const serverData = await response.json();
                    
                    // CRITICAL: Conflict Resolution Logic
                    // If local data exists and has MORE stars or MORE notebook entries, it's ahead of server.
                    if (localData && (
                        (localData.stars > (serverData.stars || 0)) || 
                        (localData.notebook && serverData.notebook && localData.notebook.length > serverData.notebook.length)
                    )) {
                        console.log("üöÄ Local data is ahead. Syncing local to server...");
                        gData = localData;
                        await saveData(); // Push local state to server
                    } else {
                        gData = serverData;
                        localStorage.setItem('french_learning_data', JSON.stringify(gData));
                    }
                    
                    updateSyncStatus("‚òÅÔ∏è Synchronis√©", "#3498db");
                } else if (localData) {
                    gData = localData;
                    updateSyncStatus("‚ö†Ô∏è Offline (Local Mode)", "#e67e22");
                }

                if (!gData.notebook) gData.notebook = [];
                
                if (!gData.daily_stats || gData.daily_stats.date !== today) {
                    const seedVal = today.split('-').reduce((a, b) => a + b.charCodeAt(0), 0);
                    let pool = DB.filter(v => !gData.notebook.some(n => n.word === v.word));
                    if (pool.length < 5) pool = [...DB];
                    
                    let newDaily = []; let tPool = [...pool];
                    let s = seedVal;
                    for (let i=0; i<5; i++) { 
                        let idx = s % tPool.length;
                        newDaily.push(tPool.splice(idx, 1)[0].word); 
                        s = s * 31 + 7; 
                    }
                    
                    gData.daily_stats = { date: today, completed: false, words: newDaily };
                    // Clear mastery progress for new day
                    localStorage.removeItem('french_session_mastery');
                    sessionStorage.removeItem('french_session_mastery');
                }
                
                gTodayWords = gData.daily_stats.words.map(wName => DB.find(d => d.word === wName));
                
                // Load session mastery from localStorage (persistent across refreshes)
                const savedSession = localStorage.getItem('french_session_mastery');
                if (savedSession) {
                    const parsedSession = JSON.parse(savedSession);
                    if (parsedSession.date === today) sessionMastery = parsedSession.data;
                    else {
                        sessionMastery = {};
                        localStorage.removeItem('french_session_mastery');
                    }
                } else {
                    // Fallback to sessionStorage for backward compatibility
                    const legacySession = sessionStorage.getItem('french_session_mastery');
                    if (legacySession) {
                        const parsedLegacy = JSON.parse(legacySession);
                        if (parsedLegacy.date === today) {
                            sessionMastery = parsedLegacy.data;
                            // Migrate to localStorage
                            localStorage.setItem('french_session_mastery', JSON.stringify(parsedLegacy));
                        } else sessionMastery = {};
                    } else sessionMastery = {};
                }
                
                // Warn user before refresh if quiz is in progress
                window.addEventListener('beforeunload', (e) => {
                    if (!gData.daily_stats.completed) {
                        const info = calculateProgress();
                        if (info.newPercent < 100) {
                            e.preventDefault();
                            e.returnValue = '‚ö†Ô∏è Quiz en cours ! Ta progression sera perdue si tu quittes maintenant.';
                        }
                    }
                });
                
                document.getElementById('sync-status').innerText = "‚úÖ Pr√™t";
                document.getElementById('sync-status').style.background = "#2ecc71";
            } catch (e) { document.getElementById('sync-status').innerText = "‚ö†Ô∏è Offline"; }
            
            refreshUI();
        }

        function calculateProgress() {
            const today = new Date().toISOString().split('T')[0];
            const newTotal = 5 * MASTERY_GOAL;
            let newCorrect = 0;
            gTodayWords.forEach(w => { 
                if (gData.notebook.some(n => n.word === w.word)) {
                    newCorrect += Math.min(MASTERY_GOAL, sessionMastery[w.word] || 0); 
                }
            });
            const newPercent = (newCorrect / newTotal) * 100;
            
            const reviewWords = DB.filter(v => { 
                const n = gData.notebook.find(e => e.word === v.word); 
                return n && n.next <= today && !gTodayWords.some(tw => tw.word === v.word); 
            });
            const revTotal = reviewWords.length * MASTERY_GOAL;
            let revCorrect = 0;
            reviewWords.forEach(w => { revCorrect += Math.min(MASTERY_GOAL, sessionMastery[w.word] || 0); });
            const revPercent = (reviewWords.length === 0) ? 100 : (revCorrect / revTotal) * 100;
            
            return { newCorrect, newTotal, newPercent, revCorrect, revTotal, revPercent, revCount: reviewWords.length };
        }

        function refreshUI() {
            document.getElementById('ui-stars').innerText = gData.stars || 0;
            document.getElementById('ui-trophies').innerText = Math.floor((gData.stars || 0) / 1000);
            document.getElementById('ui-count').innerText = gData.notebook.length;
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('ui-words-list').innerHTML = gTodayWords.map(w => `
                <div class="daily-item"><div class="mot">${w.word}</div><div class="definition">${w.def}</div><div class="exemple">"${w.ex}"</div>
                <div style="margin-top:10px"><button class="action-btn" onclick="speak('${w.word}')">üîä √âcouter</button>
                <button class="action-btn" style="background:${gData.notebook.some(n=>n.word===w.word)?'#ccc':'var(--p)'}" onclick="addWord('${w.word}')">${gData.notebook.some(n=>n.word===w.word)?'‚úÖ Ajout√©':'üìì Ajouter'}</button></div>
                </div>`).join('');

            const info = calculateProgress();
            document.getElementById('bar-n').style.width = info.newPercent + "%";
            document.getElementById('bar-r').style.width = info.revPercent + "%";
            
            const hasReview = info.revCount > 0;
            const totalPercent = hasReview ? Math.round((info.newPercent + info.revPercent) / 2) : Math.round(info.newPercent);
            document.getElementById('ui-progress').innerHTML = totalPercent + "%";
            
            const completionStatus = document.getElementById('ui-completion-status');
            if (gData.daily_stats.completed) { 
                completionStatus.innerText = "üåü MISSION ACCOMPLIE !"; completionStatus.style.color = "#2ecc71"; 
            } else if (totalPercent >= 100) { 
                completionStatus.innerText = "‚ú® PR√äT √Ä VALIDER !"; completionStatus.style.color = "#f1c40f"; 
            } else { completionStatus.innerText = ""; }

            document.getElementById('mode-n').classList.toggle('done', info.newPercent >= 100);
            document.getElementById('mode-r').classList.toggle('done', info.revPercent >= 100);

            document.getElementById('list-new').innerHTML = gData.notebook.filter(n => gTodayWords.some(tw => tw.word === n.word)).map(n => `<div onclick="showDetail('${n.word}')" style="cursor:pointer; margin-bottom:5px;">‚Ä¢ ${n.word}</div>`).join('') || "Rien encore";
            document.getElementById('list-due').innerHTML = gData.notebook.filter(n => n.next <= today && !gTodayWords.some(tw => tw.word === n.word)).map(n => `<div onclick="showDetail('${n.word}')" style="cursor:pointer; margin-bottom:5px;">‚Ä¢ ${n.word} <span class="lvl-badge">Lvl ${n.lvl}</span></div>`).join('') || (hasReview ? "Fini ! üéâ" : "Rien aujourd'hui");
            
            saveData(); saveSession(); updateQuiz();
        }

        function openNotebook() {
            renderNotebook();
            openModal('nbModal');
        }

        function renderNotebook(filterText = '') {
            const nbListEl = document.getElementById('nb-list');
            const today = new Date().toISOString().split('T')[0];
            
            if (!gData.notebook || gData.notebook.length === 0) {
                nbListEl.innerHTML = "<div class='nb-empty'>üì≠ Ton carnet est vide.<br>Commence par ajouter des mots du jour !</div>";
                document.getElementById('nb-total').innerText = '';
                document.getElementById('nb-stats').innerHTML = '';
                return;
            }

            // Filter words if search text provided
            let words = gData.notebook;
            if (filterText) {
                words = words.filter(n => n.word.toLowerCase().includes(filterText.toLowerCase()));
            }

            // Group by level
            const groups = {
                beginner: { title: 'üü† D√©butant', words: [], class: 'nb-beginner', expanded: true },
                consolidating: { title: 'üü° Consolidation', words: [], class: 'nb-consolidating', expanded: false },
                advanced: { title: 'üü¢ Avanc√©', words: [], class: 'nb-advanced', expanded: false },
                mastered: { title: 'üîµ Ma√Ætris√©', words: [], class: 'nb-mastered', expanded: false }
            };

            words.forEach(n => {
                const wordData = DB.find(d => d.word === n.word);
                if (!wordData) return;
                
                if (n.lvl <= 1) groups.beginner.words.push({...n, data: wordData});
                else if (n.lvl <= 3) groups.consolidating.words.push({...n, data: wordData});
                else if (n.lvl <= 5) groups.advanced.words.push({...n, data: wordData});
                else groups.mastered.words.push({...n, data: wordData});
            });

            // Update stats
            const total = gData.notebook.length;
            const dueToday = gData.notebook.filter(n => n.next <= today).length;
            const withErrors = gData.notebook.filter(n => n.err_days > 0).length;
            document.getElementById('nb-total').innerText = `(${total} mots)`;
            document.getElementById('nb-stats').innerHTML = `
                <div class="nb-stat"><div class="nb-stat-value">${total}</div><div>Total</div></div>
                <div class="nb-stat"><div class="nb-stat-value" style="color:#f39c12">${dueToday}</div><div>√Ä r√©viser</div></div>
                <div class="nb-stat"><div class="nb-stat-value" style="color:#e74c3c">${withErrors}</div><div>Difficult√©s</div></div>
            `;

            // Render groups
            let html = '';
            let hasContent = false;
            
            for (const [key, group] of Object.entries(groups)) {
                if (group.words.length === 0) continue;
                hasContent = true;
                
                const isExpanded = filterText ? true : group.expanded;
                const arrow = isExpanded ? '‚ñº' : '‚ñ∂';
                
                html += `
                    <div class="nb-group">
                        <div class="nb-group-header ${group.class}" onclick="toggleGroup('${key}')">
                            <span>${arrow} ${group.title}</span>
                            <span class="nb-group-count">${group.words.length}</span>
                        </div>
                        <div class="nb-group-content ${isExpanded ? '' : 'collapsed'}" id="nb-group-${key}">
                            ${group.words.map(n => {
                                const isDue = n.next <= today && !gTodayWords.some(tw => tw.word === n.word);
                                const hasError = n.err_days > 0;
                                const dueClass = hasError ? 'nb-word-error' : (isDue ? 'nb-word-due' : '');
                                const dueBadge = isDue ? ' <span style="color:#f39c12;font-size:0.8em;">‚è∞</span>' : '';
                                const errorBadge = hasError ? ` <span style="color:#e74c3c;font-size:0.8em;">‚ö†Ô∏è${n.err_days}</span>` : '';
                                
                                return `
                                <div class="notebook-item ${dueClass}" onclick="showDetail('${n.word}')">
                                    <div style="display:flex;flex-direction:column;flex:1;">
                                        <span style="font-size:1.1em;"><strong>${n.word}</strong>${dueBadge}${errorBadge}</span>
                                        <span style="font-size:0.85em;color:#666;margin-top:3px;">${n.data.def.substring(0, 50)}...</span>
                                        <span style="font-size:0.75em;color:#999;margin-top:2px;">Prochaine r√©vision: ${formatDate(n.next)}</span>
                                    </div>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="lvl-badge">Lvl ${n.lvl}</span>
                                        <button onclick="event.stopPropagation(); speak('${n.word}')" style="background:var(--s);border:none;width:35px;height:35px;border-radius:50%;color:white;font-size:1.2em;cursor:pointer;display:flex;align-items:center;justify-content:center;">üîä</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            if (!hasContent && filterText) {
                html = "<div class='nb-empty'>üîç Aucun mot ne correspond √† ta recherche.</div>";
            }

            nbListEl.innerHTML = html;
        }

        function toggleGroup(groupKey) {
            const content = document.getElementById(`nb-group-${groupKey}`);
            const header = content.previousElementSibling;
            const isCollapsed = content.classList.contains('collapsed');
            
            content.classList.toggle('collapsed');
            header.innerHTML = header.innerHTML.replace(isCollapsed ? '‚ñ∂' : '‚ñº', isCollapsed ? '‚ñº' : '‚ñ∂');
        }

        function filterNotebook() {
            const searchText = document.getElementById('nb-search').value.trim();
            renderNotebook(searchText);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            today.setHours(0,0,0,0);
            date.setHours(0,0,0,0);
            
            const diff = Math.round((date - today) / (1000 * 60 * 60 * 24));
            
            if (diff === 0) return "Aujourd'hui";
            if (diff === 1) return "Demain";
            if (diff < 0) return `En retard (${Math.abs(diff)}j)`;
            if (diff < 7) return `Dans ${diff} jours`;
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        async function saveData() { 
            localStorage.setItem('french_learning_data', JSON.stringify(gData));
            updateSyncStatus("‚è≥ Sauvegarde...", "#f1c40f");
            try { 
                const res = await fetch(`${API}/save_data`, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify(gData) 
                }); 
                if (res.ok) {
                    updateSyncStatus("‚úÖ Enregistr√©", "#2ecc71");
                } else {
                    throw new Error("Server error");
                }
            } catch(e) {
                updateSyncStatus("‚ùå Error - Local Only", "#e74c3c");
                console.error("Save failed:", e);
            }
        }

        function updateSyncStatus(msg, bg) {
            const el = document.getElementById('sync-status');
            if (el) {
                el.innerText = msg;
                el.style.background = bg;
            }
        }
        function saveSession() { localStorage.setItem('french_session_mastery', JSON.stringify({ date: new Date().toISOString().split('T')[0], data: sessionMastery })); }
        function addWord(w) { 
            if (!gData.notebook.some(n => n.word === w)) { 
                gData.notebook.push({ word: w, lvl: 0, next: new Date().toISOString().split('T')[0], err_days: 0 }); 
                speak("Ajout√©"); refreshUI(); 
            } else { speak("D√©j√† l√†"); }
        }
        function setQuizMode(m) { gGameMode = m; document.getElementById('mode-n').classList.toggle('active', m==='new'); document.getElementById('mode-r').classList.toggle('active', m==='rev'); updateQuiz(); }
        
        function updateQuiz() {
            const today = new Date().toISOString().split('T')[0];
            let pool = [];
            if (gGameMode === 'new') {
                pool = gTodayWords.filter(w => gData.notebook.some(n => n.word === w.word) && (sessionMastery[w.word] || 0) < MASTERY_GOAL);
            } else {
                pool = DB.filter(v => { 
                    const n = gData.notebook.find(e => e.word === v.word); 
                    return n && n.next <= today && !gTodayWords.some(tw => tw.word === v.word) && (sessionMastery[v.word] || 0) < MASTERY_GOAL; 
                });
            }
            
            document.getElementById('q-feedback').innerText = "";
            gIsLocked = false;

            if (pool.length < 1) { 
                const isNew = gGameMode === 'new';
                let msg = "";
                if (isNew) {
                    msg = gData.notebook.filter(n => gTodayWords.some(tw => tw.word === n.word)).length < 5 
                          ? "Ajoute les 5 mots du jour pour commencer !" 
                          : "üåü Nouveaux mots ma√Ætris√©s !";
                } else { msg = "üéâ R√©visions termin√©es !"; }
                document.getElementById('q-options').innerHTML = `<p style='padding:20px; color:var(--p); font-weight:bold; text-align:center;'>${msg}</p>`; 
                document.getElementById('q-word').innerText = "Salut !"; 
                document.getElementById('q-mastery').innerHTML = "";
                return; 
            }
            
            const target = pool[Math.floor(Math.random() * pool.length)]; 
            document.getElementById('q-word').innerText = target.word;
            const mCount = sessionMastery[target.word] || 0;
            document.getElementById('q-mastery').innerHTML = Array(MASTERY_GOAL).fill(0).map((_, i) => `<div class="dot ${i < mCount ? 'full' : ''}"></div>`).join('');
            
            let opts = [target.def]; let all = DB.map(v => v.def);
            while(opts.length < 3) { let r = all[Math.floor(Math.random()*all.length)]; if(!opts.includes(r)) opts.push(r); }
            opts.sort(() => Math.random() - 0.5);
            document.getElementById('q-options').innerHTML = opts.map(o => `<button class="opt-btn" onclick="checkQuiz(this, '${o.replace(/'/g, "\\'")}', '${target.word}')">${o}</button>`).join('');
            
            // Remove focus/outline
            if (document.activeElement) document.activeElement.blur();
        }

        function checkQuiz(btn, sel, w) {
            if (gIsLocked) return;
            gIsLocked = true;
            const target = DB.find(v => v.word === w), n = gData.notebook.find(e => e.word === w);
            const feedbackEl = document.getElementById('q-feedback');
            const allBtns = document.querySelectorAll('.opt-btn');
            allBtns.forEach(b => b.disabled = true);

            if (sel === target.def) {
                btn.classList.add('correct');
                feedbackEl.innerHTML = "‚úÖ Tr√®s bien !"; feedbackEl.style.color = "var(--s)";
                sessionMastery[w] = (sessionMastery[w] || 0) + 1;
                if (sessionMastery[w] >= MASTERY_GOAL && n) {
                    n.lvl = Math.min(6, n.lvl + 1); n.err_days = 0; 
                    let d = new Date(); d.setDate(d.getDate() + INTERVALS[n.lvl]); n.next = d.toISOString().split('T')[0]; 
                }
                gCombo++; delete gMistakes[w]; speak("Tr√®s bien"); 
                setTimeout(() => { 
                    checkDailyCompletion(); 
                    refreshProgressOnly(); 
                    updateQuiz(); 
                }, 1000);
            } else {
                btn.classList.add('wrong');
                feedbackEl.innerHTML = "‚ùå Dommage !"; feedbackEl.style.color = "var(--e)";
                sessionMastery[w] = 0;
                allBtns.forEach(b => { if(b.innerText === target.def) b.classList.add('correct'); });
                if (!gMistakes[w]) {
                    gMistakes[w] = 1;
                    setTimeout(() => { 
                        refreshProgressOnly(); 
                        updateQuiz(); 
                    }, 1800);
                } else {
                    gCombo = 0; 
                    if (n) { 
                        n.lvl = 0; let d = new Date(); d.setDate(d.getDate() + 1); n.next = d.toISOString().split('T')[0]; 
                        n.err_days = (n.err_days || 0) + 1; if (n.err_days >= 2) gData.notebook = gData.notebook.filter(e => e.word !== w);
                    }
                    delete gMistakes[w];
                    setTimeout(() => { 
                        refreshProgressOnly(); 
                        updateQuiz(); 
                    }, 1800);
                }
                speak("Dommage");
            }
        }

        function refreshProgressOnly() {
            const info = calculateProgress();
            document.getElementById('bar-n').style.width = info.newPercent + "%";
            document.getElementById('bar-r').style.width = info.revPercent + "%";
            const hasReview = info.revCount > 0;
            const totalPercent = hasReview ? Math.round((info.newPercent + info.revPercent) / 2) : Math.round(info.newPercent);
            document.getElementById('ui-progress').innerHTML = totalPercent + "%";
            document.getElementById('ui-stars').innerText = gData.stars || 0;
            saveData(); saveSession();
        }
        
        function checkDailyCompletion() {
            const info = calculateProgress();
            const hasReview = info.revCount > 0;
            const total = hasReview ? (info.newPercent + info.revPercent) / 200 : info.newPercent / 100;
            if (total >= 1.0 && !gData.daily_stats.completed) {
                gData.stars = (gData.stars || 0) + 100; gData.daily_stats.completed = true;
                setTimeout(() => { document.getElementById('rew-val').innerText = "üéâ Magnifique !\nTu as ma√Ætris√© tous les mots !\n+100 √©toiles !"; openModal('rewardModal'); speak("F√©licitations"); }, 500);
            }
        }

        function showDetail(w) { const d = DB.find(v => v.word === w); document.getElementById('detail-card').innerHTML = `<h2>${d.word}</h2><p><strong>üìù D√©finition:</strong><br>${d.def}</p><p><strong>üí¨ Exemple:</strong><br><i>"${d.ex}"</i></p><button class="action-btn" style="width:100%;margin-top:20px" onclick="speak('${d.word}')">üîä √âcouter</button>`; openModal('detailModal'); speak(w); }
        function openModal(id) { document.getElementById(id).style.display = "block"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function speak(t) { const m = new SpeechSynthesisUtterance(t); m.lang = 'fr-FR'; window.speechSynthesis.speak(m); }
        window.onclick = e => { if (e.target.className === 'modal') e.target.style.display = "none"; };
        
        // Auto-retry background sync if in error state
        setInterval(async () => {
            const el = document.getElementById('sync-status');
            if (el && el.innerText.includes("Error")) {
                console.log("Retrying background sync...");
                try {
                    const res = await fetch(`${API}/save_data`, { 
                        method:'POST', 
                        headers:{'Content-Type':'application/json'}, 
                        body:JSON.stringify(gData) 
                    });
                    if (res.ok) updateSyncStatus("‚úÖ Enregistr√©", "#2ecc71");
                } catch(e) {}
            }
        }, 30000);

        window.onload = init;
    </script>
</body>
</html>
